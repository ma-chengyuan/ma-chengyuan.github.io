<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"alan20210202.github.io","root":"/","images":"/images","scheme":"Mist","version":"8.2.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>
<meta name="description" content="不务正业高中生一枚">
<meta property="og:type" content="website">
<meta property="og:title" content="Chengyuan Ma&#39;s Blog">
<meta property="og:url" content="https://alan20210202.github.io/page/4/index.html">
<meta property="og:site_name" content="Chengyuan Ma&#39;s Blog">
<meta property="og:description" content="不务正业高中生一枚">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Chengyuan Ma">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://alan20210202.github.io/page/4/">


<script data-pjax class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/plugins/line-numbers/prism-line-numbers.min.css" integrity="sha512-cbQXwDFK7lj2Fqfkuxbo5iD1dSbLlJGXGpfTDqbggqjHJeyzx88I3rfwjS38WJag/ihH7lzuGlGHpDBymLirZQ==" crossorigin="anonymous" />
<title>Chengyuan Ma's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-65HSG5NCY6"></script>
    <script data-pjax>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-65HSG5NCY6');
      }
    </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Chengyuan Ma's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-pagedewarp"><a href="/dewarp/" rel="section"><i class="fa fa-sticky-note fa-fw"></i>PageDewarp</a></li>
        <li class="menu-item menu-item-english"><a href="/english/" rel="section"><i class="fa fa-globe-americas fa-fw"></i>English</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Chengyuan Ma"
      src="/avatar.png">
  <p class="site-author-name" itemprop="name">Chengyuan Ma</p>
  <div class="site-description" itemprop="description">不务正业高中生一枚</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">93</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      友情链接
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://kalasearch.cn/" title="https:&#x2F;&#x2F;kalasearch.cn&#x2F;" rel="noopener" target="_blank">卡拉搜索</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://alan20210202.github.io/2020/06/21/%E7%BB%84%E5%90%88%E6%B1%82%E5%92%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/avatar.png">
      <meta itemprop="name" content="Chengyuan Ma">
      <meta itemprop="description" content="不务正业高中生一枚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chengyuan Ma's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/21/%E7%BB%84%E5%90%88%E6%B1%82%E5%92%8C/" class="post-title-link" itemprop="url">论省选中有意思的一道组合题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-21 14:45:33" itemprop="dateCreated datePublished" datetime="2020-06-21T14:45:33+08:00">2020-06-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-06-27 20:01:10" itemprop="dateModified" datetime="2020-06-27T20:01:10+08:00">2020-06-27</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>省选结束了，本人作为划水3年的OIer宣告原地退役，唯一写出正解的是D1T2。我其实觉得这道题挺有意思的（虽然大佬们都说只是推式子而已……嘛，毕竟本来没期待自己能做出来），就写篇文章记一下自己的想法吧。</p>
<h1 id="题意">题意</h1>
<p>给定整数<span class="math inline">\(n, x, P\le 10^9\)</span>，以及一个<span class="math inline">\(m \le 1000\)</span>次整系数多项式<span class="math inline">\(f\)</span>，求 <span class="math display">\[
\left[\sum_{k=0}^nf(k)x^k\binom{n}{k}\right]\bmod P
\]</span></p>
<h1 id="心路历程">心路历程</h1>
<h2 id="先乱搞一波">先乱搞一波</h2>
<p>看到这个题目的第一眼我觉得颇为眼熟。虽然没学过奥数，印象当中《具体数学》里面花了很大笔墨讲由这种指数，多项式以及二项式系数组合而成的和式的处理方法，似乎最后也讲到了机械求和法，然并卵，印象止步于印象，机械求合法太复杂了自己并没有记下来。</p>
<p>但是自己的残存记忆告诉我机械求和法的第一步是把求和式化成超几何函数，虽然后者我更没办法但是本着有逼就要装的思想……为什么不试一试呢？</p>
<p>什么样的级数是超几何的？《具体数学》里面给出的方法是求相邻项之比<del>幸好这个我还没有忘记</del>，而显而易见地是多项式求比是求不出具有良好形式的结果的，因此<strong>多项式必须转化为性质更优良的下降阶乘幂处理</strong>（关于下降阶乘幂我记得两年之前就写过一篇成套方法和有限微积分的博文，现在想来下降阶乘幂在离散求和问题当中真的有非常良好的性质，我在这里就沿用《具体数学》里的记号了：<span class="math inline">\(k^{\underline m} = \prod_{i=0}^m (k-i)\)</span>）： <span class="math display">\[
\begin{aligned}
\frac{(k+1)^{\underline{m}}x^{k+1}\binom{n}{k+1}}{k^{\underline{m}}x^k\binom{n}{k}} &amp;= \frac{(k+1)x(n-k)}{(k-m+1)(k+1)} \\
&amp;= \frac{(n-k)x}{k-m+1}
\end{aligned}
\]</span> 不出所料，结果是一个有理函数，也就是说可以化成高斯超几何函数呢！</p>
<p>不出所料，半瓶水的某人也就知道这些了（悲）。</p>
<p>但是<strong>下降阶乘幂的思想是可以有的嘛</strong>！</p>
<h2 id="部分分摸鱼">部分分摸鱼</h2>
<p>在乱搞如预想的那般失败之后我就开始看部分分。</p>
<p>部分分里面有一个<span class="math inline">\(f\)</span>是常数的，愣了一会发现能用二项式定理，答案是<span class="math inline">\((1+x)^n\)</span>。</p>
<p>然后还有一个<span class="math inline">\(x=1\)</span>的。这个要怎么解决？</p>
<p>从最简单的一次多项式开始： <span class="math display">\[
\sum_{k=0}^nk\binom{n}{k}=?
\]</span> 推式子本人是不会的，结论也忘了，但是从组合意义上还是好想的：<strong><span class="math inline">\(k\binom{n}{k}\)</span>就是从<span class="math inline">\(n\)</span>个人里面选<span class="math inline">\(k\)</span>个人，然后钦定一个做队长的方案数，把它求和，就是从<span class="math inline">\(n\)</span>个人里面选若干人，然后从当中钦定一个队长的方案数。</strong>这是先选人再定队长的顺序，我们可以先选队长再选人嘛！从<span class="math inline">\(n\)</span>个人里面选一个队长有<span class="math inline">\(n\)</span>种方法，剩下的<span class="math inline">\((n-1)\)</span>个人要不要都行，所以是<span class="math inline">\(2^{n-1}\)</span>种，二者相乘： <span class="math display">\[
\sum_{k=0}^nk\binom{n}{k}=n2^{n-1}
\]</span> 就把一次的式子推出来了。</p>
<p>那二次的式子呢？ <span class="math display">\[
\sum_{k=0}^nk^2\binom{n}{k}=?
\]</span> 如果沿用之前运用组合意义化简的思路，那<span class="math inline">\(k^2\)</span>就有“可以重复选”的含义在，是不好处理的。但是之前的乱搞告诉我们，是不是化成下降阶乘幂会好处理一点呢？ <span class="math display">\[
\sum_{k=0}^nk(k-1)\binom{n}{k}=?
\]</span> 答案是肯定的，思路和一次的完全一样，只是从“选队长”变成了“选队长和副队长“，因此很快就可以得出： <span class="math display">\[
\sum_{k=0}^nk(k-1)\binom{n}{k}=n(n-1)2^{n-2}
\]</span> 然后就可以很快地推广出去了： <span class="math display">\[
\sum_{k=0}^nk^{\underline{m}}\binom{n}{k}=n^{\underline{m}}2^{n-m}
\]</span> 这样几个部分分就基本拿到了。</p>
<h2 id="把两者组合起来">把两者组合起来</h2>
<p>那如果<span class="math inline">\(x\neq 1\)</span>且<span class="math inline">\(f\)</span>非常数要怎么做呢？我们不妨还是把<span class="math inline">\(f\)</span>想成下降阶乘幂（怎么拆另说）： <span class="math display">\[
\sum_{k=0}^nk^{\underline{m}}x^k\binom{n}{k}=?
\]</span> 然后思考其组合意义，稍开脑洞即可得到：</p>
<p><strong><span class="math inline">\(k^{\underline{m}}x^k\binom{n}{k}\)</span>是从<span class="math inline">\(n\)</span>个人里面挑选<span class="math inline">\(k\)</span>个人，再给让当中<span class="math inline">\(m\)</span>人担任<span class="math inline">\(m\)</span>个不同职位，最后再让每个人从<span class="math inline">\(x\)</span>种颜色的帽子当中选一个戴上的方案数</strong>（不要问我怎么想到戴帽子的）。</p>
<p>因此，由加法原理，对其求和之后就是从<span class="math inline">\(n\)</span>个人里面挑选<em>若干</em>个人，再给让当中<span class="math inline">\(m\)</span>人担任<span class="math inline">\(m\)</span>个不同职位，最后再让每个人从<span class="math inline">\(x\)</span>种颜色的帽子当中选一个戴上的方案数。</p>
<p>那我们故技重施，调换顺序，不妨先从<span class="math inline">\(n\)</span>个人当中调出担任<span class="math inline">\(m\)</span>个职位的那<span class="math inline">\(m\)</span>个人（<span class="math inline">\(n^{\underline{m}}\)</span>种取法），再先让他们先选帽子（<span class="math inline">\(x^m\)</span>种选法），然后让剩下的<span class="math inline">\((n-m)\)</span>个人要不挑一个颜色的帽子进队要么滚蛋（<span class="math inline">\((1+x)^{n-m}\)</span>种取法）。于是就有了： <span class="math display">\[
\sum_{k=0}^nk^{\underline{m}}x^k\binom{n}{k}=n^{\underline{m}}x^m(1+x)^{n-m}
\]</span> 哇，式子就推出来了！</p>
<h2 id="多项式拆分">多项式拆分</h2>
<p>现在基于下降阶乘幂的式子已经推出来了，唯一剩下的就是把给定的<span class="math inline">\(f\)</span>拆成若干个下降阶乘幂的线性组合。 <span class="math display">\[
\sum_{i=0}^ma_ik^i = \sum_{j=0}^m b_jk^{\underline{j}}
\]</span> 即求<span class="math inline">\(b_j\)</span>的过程。</p>
<p>显而易见地，我们需要从高次到低次拆，这样后拆出来的幂才不会对之前的结果造成影响。</p>
<p>同时显然的是，我们需要知道下降阶乘幂展开后对应多项式的系数。</p>
<p>现在回过来看，朴素的多项式乘法是完全可以胜任的。但是写多项式乘法毕竟比较繁琐，不如观察多项式系数的规律。</p>
<p>令<span class="math inline">\(c[m, n]\)</span>表示下降阶乘幂<span class="math inline">\(x^{\underline m}\)</span>的展开式当中<span class="math inline">\(x^n\)</span>的系数。则由下降阶乘幂的定义： <span class="math display">\[
x^{\underline m} = x^{\underline{m-1}}[x-(m-1)],\quad (m\ge 1)
\]</span> 可以得出递推式： <span class="math display">\[
c[m,n]=c[m-1,n-1]-(m-1)c[m-1,n]
\]</span> 边界条件是<span class="math inline">\(c[0,0] = 1\)</span>以及<span class="math inline">\(c[m,0]=0\quad \forall m&gt;0\)</span>。这是一个类似杨辉三角的递推式，自然可以在<span class="math inline">\(\mathcal{O}\left(m^2\right)\)</span>的时间内算出来，代码也好写。</p>
<p>至此，这道题目就完全解决了。</p>
<p>其实不止如此，这个三角在考场上让我感到非常眼熟，回去查证了一下，果然<span class="math inline">\(c[m,n]\)</span>就是所谓的<strong>带符号的第一类斯特林数</strong>，“下降阶乘幂的展开系数”正是其重要的性质之一。</p>
<h2 id="感想">感想</h2>
<p>这道题对我的感触是比较深刻的，尤其是做出来之后，颇有一种成就感。</p>
<p>细想来，我组合数学的公式其实几乎都没有背过，故而几乎所有的式子都是现场推出来的。而且推理的方式也不纯代数的暴算，而是通过combinatorial proof的方式。自从PACT学来这招之后我觉得这种方法实在是精妙。在最后自己还稀里糊涂地推演出了斯特林数的递推公式，或许这种高大上的组合数本身离我们就不遥远吧。</p>
<p>而话又说回来，大佬们看我写的这篇文章，只怕有些不耐烦与乏味吧。那些认真学习过组合数学的选手，大概看到这道题只剩下满满的套路，毕竟斯特林数名声在外，falling factorial这个套路熟悉了也不难想到，而类似的组合式子大概课后的习题会有很多吧。看到诸多大佬将D1T2云淡风轻地说成“裸的推式子”，他们做这道题时的从容大概可见一斑。只有像自己这样偶尔翻翻《组合数学》和《具体数学》，半瓶水晃荡的，才会在考场上各种心情复杂，一惊一乍了。</p>
<p>然而换一个角度，我觉得这道题对我来说真的不错，自己之前偶尔翻翻书也是。作为一道数学题，这道题并没有远远超出我的见识让我一筹莫展，也没有远远低于我的见识让我秒杀，恰是我稍微努力一下就能解决的。而这次考试正是给了日渐颓废，游手好闲的我一个“努力一下”的契机。就结果来看，解决这道题不仅给了我市选的信心，也给了我组合数学的信心，还让我在结题过程中观赏到了极佳的风景，似乎确实不赖。尤其是后者，若放在平时做题，随时可以查找资料，正确答案触手可及，那结论得出时大概也不会有考场上那么惊喜，那么愉悦了。</p>
<h2 id="逆-转">逆 转</h2>
<p>啊？出分了？！</p>
<p>我考个250都能压线进队？！</p>
<p>我可是根本就没认真复习啊，半年没碰OI了……</p>
<p>唉，看来这次强行退役失败了，心情复杂……</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://alan20210202.github.io/2020/04/17/PanDownload/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/avatar.png">
      <meta itemprop="name" content="Chengyuan Ma">
      <meta itemprop="description" content="不务正业高中生一枚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chengyuan Ma's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/04/17/PanDownload/" class="post-title-link" itemprop="url">自己对于PanDownload的一些想法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-04-17 16:19:14 / 修改时间：19:45:59" itemprop="dateCreated datePublished" datetime="2020-04-17T16:19:14+08:00">2020-04-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>PanDownload前几天被封了。</p>
<p>网络上那个群情激奋啊，看B站连“百度的七宗罪”都出来了。还有人把GFW做的DNS污染，域名置换等和PanDownload做的“多线程下载百度云盘”相并列，不乏讥讽地质问为何遭到制裁的是看起来程度最轻的PanDownload。</p>
<p>我不是PanDownload的使用者，自己也很少用百度云盘，或许称不上是特别利益相关者吧。</p>
<p>但看到这个新闻的时候我是很矛盾的。</p>
<p>我讨厌百度吗？</p>
<p>肯定的，我从八年前开始用百度云盘，从不限速的年代一路用到限速的坑爹时代，不恨是不可能的。</p>
<p>我喜欢PanDownload吗？</p>
<p>喜欢的，我自己两三年以前还在用很多油猴的提取直连的脚本，这种绕开限速薅羊毛的软件我不要太喜闻乐见。</p>
<p>那在这次事件中我支持PanDownload吗？</p>
<p>我其实想保持中立。</p>
<p>我们对于PanDownload等一众软件的推崇源于对于百度免费用户限速的痛恶。由俭入奢易由奢入俭难，对于限速的痛恶则源于几年前限速不存在的事实。</p>
<p>但是仔细想想，免费的大云盘这件天上掉馅饼的事情合理吗？</p>
<p>参照如今硬盘的价格以及带宽的价格，我觉得百度留着云盘业务肯定不是做慈善的。在线存储是一种服务，是企业生产的一种产品，收费这件事情本身是无可厚非的。放眼国外市场，Dropbox，Google Drive等也没有做慈善的。不是空间小就是下载慢。</p>
<p>要说百度可恶，也就可恶给用户提供了“一开始的美好”，用2TB的存储空间诱惑用户，等用户粘性培养上来之后，在几年前再限速到一个坑爹的地步，这个时候你左右为难。付钱吧，跟几年前比感觉亏了，不付钱吧，自己很多数据还存着呢。反正百度这几年的潜台词是越来越明显了：不付钱别玩，让你免费用已经是施舍你了，还BB那么多干嘛。</p>
<p>这句话很让人恼火，非常让人恼火，但是仔细思考一下，似乎是对的。云盘是一个市场，在市场里哪有永远白嫖的份。这个时候最好的结局是期待着市场竞争逼着百度降价。但是我国云盘市场的竞争着实不够激烈，百度隐隐形成垄断之势，降价看来是遥遥无期了（话又说回来，一个月25块钱的价格换算成美元大概与Google Drive差不多，其实真没那么多好抱怨的）。</p>
<p>这个时候PanDownload以及一众多线程下载软件出现了。几十个线程一起下，让免费用户看到了曙光。</p>
<p>我们不妨把PanDownload看做是网盘市场的一个有力的竞争者（虽然竞争并非其初衷），把它的下载服务看做是一个全新的网盘产品，它提供的“网盘产品”的竞争性优势在于</p>
<ol type="1">
<li>和已有百度网盘资料的完全兼容</li>
<li>免费用户的高速下载</li>
</ol>
<p>如果PanDownload的网盘产品真的是独立而全新的，那百度该死，谁也不能阻止PanDownload一统江湖。</p>
<p>但是事实不是这个样子的，PanDownload提供的这个如此有竞争性的“产品”，是基于百度网盘的生产资料与资本建立起来的。PanDownload运用的多线程下载，亦或是其他软件的直链提取，这些都不是百度网盘官方提供的API，也不是百度网盘官方认可的。</p>
<p>因此，全民的喜闻乐见与对于百度的痛恨，也改变不了PanDownload不正当竞争（视作竞争者）或者说侵犯百度权益（是做第三方软件）的事实。</p>
<p>单纯地因为PanDownload是在造福人类，是在薅垃圾公司的羊毛，就对这种行为的本质视而不见，其实是违背法治社会的初衷的。</p>
<p>这就仿佛所有人都认为张三是人渣，李四替天行道把张三打死了就可以不犯法一样。事实上，哪怕张三是在逃的杀人犯过街喊打喊打，如果不处于类似正当防卫的情形，李四把张三打死也是不对的。故意杀人就是故意杀人。何况百度作为一家公司目前来看还没有在云盘的运营中触犯法律（或许有垄断？不清楚）。前几天在B站上看罗翔老师说“法律要考虑民众的诉求，但是要超越民众的偏见”。</p>
<p>百度这叫体量大，如果是一家新创业的公司，被这么一集体白嫖，搞得破产了怎么办？这种事情不是没有发生过。难道法律里面还要加入一条“如果体量够大而且民众不爽，某某法规就失效”？</p>
<p>如果对百度不爽，就尽量避免去用它。现在搭建一个自己的网盘已经是很简单的一件事情了。</p>
<p>何况部分用户离不开百度网盘的原因大概是因为下”资源“，所谓”资源“，又大致可以分为免费（说的不好一点就是盗版）的电影与一些淫秽资源。后者我不想多说啥（其实吧，我觉得一些黄站之于内容提供者也是PanDownload之于百度网盘的存在），但是免费下盗版竟然还有理了？</p>
<p>没错，一直白嫖一直爽是中文互联网的常态，我自己也爱装破解版软件，看视频听音乐能不付钱就不付钱，但是理直气壮地说出来又是另一回事情了。百度给你下就不错了，PanDownload让你下爽了就下爽了，但是这种处于灰色地带的软件，要较真起来，我们真的不占理。</p>
<p>或许吧，网民一直隐隐有一种心态，在网络上白嫖是对的，反正就是一堆数据拷来拷去，百度云盘也就是一个网站而已，付费下载闻所未闻。这种心态在我看来是有问题的。垄断着实可恶，但是支付给服务提供者报酬的道理还是不错的。</p>
<p>因此，我觉得PanDownload虽然对于我们是一款好软件，但是最近取缔PanDownload这一事，我觉得还是无可厚非的。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://alan20210202.github.io/2020/04/17/IceBoat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/avatar.png">
      <meta itemprop="name" content="Chengyuan Ma">
      <meta itemprop="description" content="不务正业高中生一枚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chengyuan Ma's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/04/17/IceBoat/" class="post-title-link" itemprop="url">从技术角度看Minecraft的高级冰船技术</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-04-17 09:09:53 / 修改时间：22:43:43" itemprop="dateCreated datePublished" datetime="2020-04-17T09:09:53+08:00">2020-04-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景">背景</h1>
<p>最近比较无聊，偶尔会和同学们一起在Minecraft的私服上玩一会，现在地狱交通已经初见雏形了，nether hub已经搭好了，然而地狱交通网络应该基于哪一种运输方式还没有确定。常见的快速运输方式有两种：piston bolt和冰船。</p>
<p>很显然按照每天半个小时的游戏时间是不可能有精力做双向的piston bolt的，况且论最高速度冰船比piston bolt还是快上许多的，因此几乎毫无疑议地大家都选择了冰船。</p>
<p>这篇文章是在代码角度对于高级冰船技术的分析。</p>
<p>全文的代码均为使用官方mapping以及CFR编译器进行反编译所得（但愿这并不违反EULA）。</p>
<h1 id="带方向校准的高端冰船">带方向校准的高端冰船</h1>
<p>冰船系统一直为人所诟病，也是其不如piston bolt的一点是：它在运动中是需要玩家控制的。不仅要一直按着W，还要使用AD确保船头一直向前。这在直道冰船上还好，但在斜线冰船道上就非常非常麻烦。</p>
<p>幸好，Rays Works在几个月前分享了<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=hiQTnwqrfEU">解决方案</a>。其方案的思想是：</p>
<p>如果一开始船就放正，那么就只需要W而不需要左右调整了！</p>
<p>那怎么把船放正呢？</p>
<p>观察一下代码（<code>net/minecraft/world/item/BoatItem</code>）：</p>
<pre class="line-numbers"><code class="language-java">@Override
public InteractionResultHolder&lt;ItemStack&gt;use(Level level, Player player, InteractionHand interactionHand) &#123;
    Object object;
    ItemStack itemStack = player.getItemInHand(interactionHand);
    HitResult hitResult = BoatItem.getPlayerPOVHitResult(level, player, ClipContext.Fluid.ANY);
    ...
    if (hitResult.getType() == HitResult.Type.BLOCK) &#123;
        object = new Boat(level, hitResult.getLocation().x, hitResult.getLocation().y, hitResult.getLocation().z);
        ((Boat) object).setType(this.type);
        ((Boat) object).yRot = player.yRot; // !
        ...
        return InteractionResultHolder.success(itemStack);
    &#125;
    return InteractionResultHolder.pass(itemStack);
&#125;</code></pre>
<p><code>yRot</code>自然是Y-axis Rotation的意思，也就是说放下船的方向直接等于当时玩家的视角方向。</p>
<p>因此如果一开始视角方向， 那么问题就解决了！</p>
<p>如何确保每一次放船的时候视角方向都是一个固定值呢？</p>
<p>Rays Works的解决方案是：用另外一艘船！</p>
<p>在<code>net/minecraft/client/player/LocalPlayer</code>当中：</p>
<pre class="line-numbers"><code class="language-java">@Override
public boolean startRiding(Entity entity, boolean bl) &#123;
    if (!super.startRiding(entity, bl)) &#123;
        return false;
    &#125;
    ...
    if (entity instanceof Boat) &#123; // !!!
        this.yRotO = entity.yRot;
        this.yRot = entity.yRot;
        this.setYHeadRot(entity.yRot);
    &#125;
    return true;
&#125;</code></pre>
<p>可以看到，当玩家乘上船的一瞬间，玩家的视角方向会强制调整到船的方向。</p>
<p>因此我们只需要准备一艘校准船，确保这艘船的角度正确，之后要使用的时候直接先做上这艘船再立刻放船再坐上新放的船就可以了（简单来说就是三连右键）。</p>
<p>这就是Rays Works视频的主旨，我这里只是找到了对应的源代码而已。</p>
<h1 id="放置角度与minecraft的角度系统">放置角度与Minecraft的角度系统</h1>
<p>Rays Works在视频当中宣称通过它的方法可以把冰道修到任何角度与朝向。</p>
<p>似乎没有什么不对？只要把校准船放到任意角度就行了。</p>
<p>然而在Ray的视频当中可以看到，有的时候明明船放下去是45°，不一会就转到了46.4°，Ray坦言这是这套冰船系统唯一比较麻烦的地方。Ray提出的解决方案是：</p>
<blockquote>
<p>If that happens, just remove this boat and place in a new one. ……and do it a couple times it actually fixes itself.</p>
</blockquote>
<p>并认为这是一个随机行为，具有一定意义上的周期性，等一会就好了。</p>
<p>事实并非如此。有一些角度是无论如何都放不到的，刚放下去一会就会微微一转，然后角度就变了。属实糟心，我在自己服务器里面放了20次都没有放成功。那个时候我终于意识到Ray的claim可能是在扯淡，于是去看了下代码。</p>
<p>代码里面似乎没有任何一处体现了“微微一转”这种行为。最上面<code>BoatItem</code>的代码就是直接把<code>yRot</code>设成了玩家的<code>yRot</code>。我用全文搜索对于<code>yRot</code>产生修改的片段，没有一处是这样的。<code>yRot</code>是用<code>float</code>存储的，应该不会产生舍入误差这种事情。</p>
<p>整个事情让我对于Minecraft的屎山代码不由生出一份敬畏，我开始觉得这是玄学问题，直到看见<code>net/minecraft/network/protocol/game/ClientboundAddEntityPacket</code>的构造函数……</p>
<pre class="line-numbers"><code class="language-java">public class ClientboundAddEntityPacket implements Packet&lt;ClientGamePacketListener&gt; &#123;
    ...
    private int xRot;
    private int yRot;

    public ClientboundAddEntityPacket(int n, UUID uUID, double d, double d2, double d3, float f, float f2, EntityType&lt;?&gt; entityType, int n2, Vec3 vec3) &#123;
        ...
        this.xRot = Mth.floor(f * 256.0f / 360.0f);
        this.yRot = Mth.floor(f2 * 256.0f / 360.0f);
        ...
    &#125;
&#125;</code></pre>
<p>以及<code>net/minecraft/client/multiplayer/PacketListener</code>如何处理这个packet的:</p>
<pre class="line-numbers"><code class="language-java"> @Override
 public void handleAddEntity(ClientboundAddEntityPacket clientboundAddEntityPacket) &#123;
     Entity entity;
     ...
     if (entity != null) &#123;
         entity.xRot = (float)(clientboundAddEntityPacket.getxRot() * 360) / 256.0 f;
         entity.yRot = (float)(clientboundAddEntityPacket.getyRot() * 360) / 256.0 f;
         ...
     &#125;
 &#125;</code></pre>
<p>哦……原来还真有舍入误差这回事……Mojang大概想省空间，虽然rotation在客户端和服务端内部都是<code>float</code>存储的，但是在网络传输的时候硬是塞到了<code>byte</code>里面。于是在这一层转换的帮助下，Minecraft理论上就只有256种可能的角度了。</p>
<p>我猜测的整个放船的流程大致如下：</p>
<ol type="1">
<li>客户端玩家手持船右键</li>
<li>客户端发出一个<code>ServerboundUseItemPacket</code></li>
<li>服务端接收到<code>ServerboundUseItemPacket</code>，然后执行<code>BoatItem</code>有关的代码</li>
<li>服务端新增船的实体，想客户端发送<code>ClientboundAddEntityPacket</code>，这个时候角度被舍入了</li>
<li>客户端收到<code>ClientboundAddEntityPacket</code>，将本地的船同步为舍入的角度，在10gt的插值作用下体现为“微微一转”</li>
<li>玩家坐上去，这个时候一系列网络同步把服务端的船的角度也舍入了</li>
</ol>
<pre class="line-numbers mermaid"><code class="language-none">sequenceDiagram
    participant Client
    participant Server
    Note left of Client: Player right clicks
    Client-&gt;&gt;Server: ServerboundUseItemPacket
    Note right of Server: Execute code in &lt;br/&gt; BoatItem.use
    Server-&gt;&gt;Client: ClientboundAddEntityPacket</code></pre>
<p>因此，微微一转的问题其实根本就不是Ray说的随机事件，而是在网络传输当中舍入误差加上客户端线性插值带来的现象。看似的随机只是因为F3的精度不够，44.99和45.01都显示为45.0，虽然从代码当中我们可以清晰地看到两个数的舍入结果是不一样的。</p>
<p>这么做的好处是对于90°，45°等特殊角这一层舍入可以保证绝对的精确，避免了放成45.01°然后在船上开1000格偏离航道的惨剧。缺点是很多角度就不能精确达到了。两个相邻的可达角度差1.40625°，大概勉强可以接受。</p>
<p>话又说回来了，<code>ServerboundMovePlayerPacket</code>这种同步玩家信息倒是还是用<code>float</code>作为载体的。所以玩家的角度还是很精确的？难道是因为玩家相对于实体少很多所以有更多流量可以挥霍？</p>
<p>我再次对于Minecraft的代码肃然起敬。</p>
<h1 id="辅助高级冰船的scarpet脚本">辅助高级冰船的Scarpet脚本</h1>
<p>在知道这些之后我们就可以有针对性地设计冰道了，因为人比较懒所以我写了一个scarpet的脚本：</p>
<pre class="line-numbers"><code class="language-none">__command() -&gt; null;

_ice_mark(x, y, z) -&gt; create_marker(&#39;ICE&#39;, l(x + 0.5, y + 0.5, z + 0.5));

_mark_x(y, x1, z1, x2, z2, w) -&gt; (
    if(x1 &gt; x2, l(x1, x2, z1, z2) = l(x2, x1, z2, z1));
    k = (z2 - z1) / (x2 - x1);
    for(range(x1, x2 + 1),
        x = _; z = round((x - x1) * k + z1);
        for(range(-w + 1, w), _ice_mark(x, y, z + _))
    )
);

_mark_z(y, x1, z1, x2, z2, w) -&gt; (
    if(z1 &gt; z2, l(x1, x2, z1, z2) = l(x2, x1, z2, z1));
    k = (x2 - x1) / (z2 - z1);
    for(range(z1, z2 + 1),
        z = _; x = round((z - z1) * k + x1);
        for(range(-w + 1, w), _ice_mark(x + _, y, z))
    )
);

mark(y, x1, z1, x2, z2, w) -&gt; (
    dx = abs(x1 - x2); dz = abs(z1 - z2);
    if(dx == 0 || dx &lt; dz, _mark_z(y, x1, z1, x2, z2, w),
        _mark_x(y, x1, z1, x2, z2, w))
);

clear() -&gt; remove_all_markers();

_wrap_deg(x) -&gt; (
    tmp = x % 360.0;
    if(tmp &lt; -180, tmp + 360, tmp &gt; 180, tmp - 360, tmp)
);

_wrap_internal(x) -&gt; (
    tmp = x % 360.0;
    if (tmp &lt; 0, tmp + 360, tmp)
);

_angle(x1, z1, x2, z2) -&gt; -atan2(x2 - x1, z2 - z1);

_floor_angle(x) -&gt; _wrap_deg(floor(x * 256 / 360.0) * 360 / 256);

angle(x1, z1, x2, z2) -&gt; (
    theta = _angle(x1, z1, x2, z2);
    print(str(&#39;exact yaw: %f&#39;, theta));
    lb = floor_angle(_wrap_internal(theta));
    ub = floor_angle(_wrap_internal(theta + 360.0 / 256));
    print(str(&#39;floored yaw (lb): %f&#39;, lb));
    print(str(&#39;floored yaw (ub): %f&#39;, ub));
    ret = if(abs(lb - theta) &lt; abs(ub - theta), lb, ub);
    print(str(&#39;suggested yaw: %f&#39;, ret));
);

_best_angle(x1, z1, x2, z2) -&gt; (
    theta = _angle(x1, z1, x2, z2);
    lb = floor_angle(_wrap_internal(theta));
    ub = floor_angle(_wrap_internal(theta + 360.0 / 256));
    if(abs(lb - theta) &lt; abs(ub - theta), lb, ub)
);

adjust(x1, z1, x2, z2, dir) -&gt; (
    x = _best_angle(x1, z1, x2, z2);
    ov = 360; opt = 0;
    print(str(&#39;yaw: %f&#39;, x));
    if(
        dir == &#39;x&#39;,
        for(range(x2 - 1000, x2 + 1000), 
            tmp = abs(_angle(x1, z1, _, z2) - x);
            if (tmp &lt; ov, ov = tmp; opt = _)
        );
        print(str(&#39;%f %f %f %f&#39;, x1, z1, opt, z2)),
        dir == &#39;z&#39;,
        for(range(z2 - 1000, z2 + 1000), 
            tmp = abs(_angle(x1, z1, x2, _) - x);
            if (tmp &lt; ov, ov = tmp; opt = _)
        );
        print(str(&#39;%f %f %f %f&#39;, x1, z1, x2, opt)),
        print(&#39;direction must either be x or z&#39;)
    )
)</code></pre>
<p>用法如下：</p>
<ol type="1">
<li><p><code>/iceboat y x1 z1 x2 z2 w</code>标记一条从<span class="math inline">\((x_1,y,z_1)\)</span>到<span class="math inline">\((x_2,y,z_2)\)</span>的，宽度为<span class="math inline">\(2w-1\)</span>的冰道。</p></li>
<li><p><code>/iceboat clear</code>清除标记。</p></li>
<li><p><code>/iceboat angle x1 z1 x2 z2</code>计算站在<span class="math inline">\((x_1,z_1)\)</span>望向<span class="math inline">\((x_2,z_2)\)</span>的视角方向，最近的两个可达角度，以及推荐的可达角度。</p></li>
<li><p><code>/iceboat adjust x1 z1 x2 z2 x/z</code>固定<span class="math inline">\((x_1,z_1)\)</span>，沿<span class="math inline">\(x/z\)</span>轴在<span class="math inline">\((x_2,z_2)\)</span>附近寻找最贴近可达角度的方块坐标。考虑到在几千格之后哪怕0.7°的角度差都会有导致最终百格的偏差，这个命令非常重要。在算法实现角度，用三分写是最快的，但是考虑到从-180°到180°有一个不连续间断点，导致写三分会涉及到一些繁琐的细节。我比较懒，所以就用了比较慢的写法（这个写法其实也有明显bug，但是我不准备修）。</p></li>
</ol>
<p>常见的使用流程：</p>
<ol type="1">
<li>确定冰道的两点。</li>
<li>固定一点（通常是nether hub或者已经固定留好空间的端点），使用<code>/iceboat adjust</code>微调另一端点的位置。同时计算得出角度。</li>
<li>使用<code>/iceboat mark</code>标记放冰的位置。</li>
<li>放冰。</li>
<li>使用<code>/iceboat clear</code>清除标记。</li>
</ol>
<p>目前比较不人性化的一点是carpet的<code>create_marker</code>用的是隐形盔甲架实现的，hitbox的制约导致有的时候放不了方块，用area effect cloud可能可以解决这个问题。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://alan20210202.github.io/2020/04/03/Gradle%E5%88%9D%E6%8E%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/avatar.png">
      <meta itemprop="name" content="Chengyuan Ma">
      <meta itemprop="description" content="不务正业高中生一枚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chengyuan Ma's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/04/03/Gradle%E5%88%9D%E6%8E%A2/" class="post-title-link" itemprop="url">Gradle初探</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-04-03 20:02:19 / 修改时间：22:26:34" itemprop="dateCreated datePublished" datetime="2020-04-03T20:02:19+08:00">2020-04-03</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>自己最近又在用JVM系的语言开新坑。这次终于说服自己从Jetbrains的温床里脱离出来改用了大家都在用的Gradle！感觉良好，在这里简单写一下大概咋用，给之后的自己留一个参考吧。</p>
<p>为什么自己要用Gradle呢？</p>
<ol type="1">
<li>Gradle作为一个开源的构建系统不与任何IDE绑定（比如说IDEA），这相当于增加了代码的兼容性。</li>
<li>Gradle里面可以直接从Maven Central上下库下来，省了我手动下库导入的过程，库更新了也好维护。这对我来说非常地有诱惑力。实测也非常舒服。</li>
<li>Gradle从设计上来说非常灵活，Gradle默认的构建脚本是用Groovy写的（当然也可以用Kotlin但是这似乎不是主流的样子），而不是只有标记功能的XML，这使Gradle一下子非常强大。</li>
<li>大家都在用的样子。</li>
<li>IDEA对于Gradle的支持非常棒！（所以到头来自己还是没有逃脱JB的舒适圈……）</li>
</ol>
<p>虽然说Gradle的功能很强大我目前的用法还是最初级的。我目前用的Gradle代码大致如下：</p>
<pre class="line-numbers"><code class="language-groovy">plugins &#123;
    id &#39;java&#39;
    id &#39;org.jetbrains.kotlin.jvm&#39; version &#39;1.3.61&#39;
&#125;

group &#39;chengyuan&#39;
version &#39;1.0-SNAPSHOT&#39;

sourceCompatibility = 1.8
project.ext.lwjglVersion = &quot;3.2.3&quot;
project.ext.lwjglNatives = &quot;natives-windows&quot;

repositories &#123;
    maven &#123; url &#39;http://maven.aliyun.com/nexus/content/groups/public/&#39; &#125;
    maven &#123; url &quot;https://oss.sonatype.org/content/repositories/snapshots/&quot; &#125;
    mavenCentral()
&#125;

dependencies &#123;
    implementation platform(&quot;org.lwjgl:lwjgl-bom:$lwjglVersion&quot;)
    
    implementation &quot;org.lwjgl:lwjgl&quot;
    implementation &quot;org.lwjgl:lwjgl-assimp&quot;
    implementation &quot;org.lwjgl:lwjgl-bgfx&quot;
    implementation &quot;org.lwjgl:lwjgl-glfw&quot;
    implementation &quot;org.lwjgl:lwjgl-nanovg&quot;
    implementation &quot;org.lwjgl:lwjgl-nuklear&quot;
    implementation &quot;org.lwjgl:lwjgl-openal&quot;
    implementation &quot;org.lwjgl:lwjgl-opengl&quot;
    implementation &quot;org.lwjgl:lwjgl-par&quot;
    implementation &quot;org.lwjgl:lwjgl-stb&quot;
    implementation &quot;org.lwjgl:lwjgl-vulkan&quot;
    runtimeOnly &quot;org.lwjgl:lwjgl::$lwjglNatives&quot;
    runtimeOnly &quot;org.lwjgl:lwjgl-assimp::$lwjglNatives&quot;
    runtimeOnly &quot;org.lwjgl:lwjgl-bgfx::$lwjglNatives&quot;
    runtimeOnly &quot;org.lwjgl:lwjgl-glfw::$lwjglNatives&quot;
    runtimeOnly &quot;org.lwjgl:lwjgl-nanovg::$lwjglNatives&quot;
    runtimeOnly &quot;org.lwjgl:lwjgl-nuklear::$lwjglNatives&quot;
    runtimeOnly &quot;org.lwjgl:lwjgl-openal::$lwjglNatives&quot;
    runtimeOnly &quot;org.lwjgl:lwjgl-opengl::$lwjglNatives&quot;
    runtimeOnly &quot;org.lwjgl:lwjgl-par::$lwjglNatives&quot;
    runtimeOnly &quot;org.lwjgl:lwjgl-stb::$lwjglNatives&quot;
    
    testCompile group: &quot;junit&quot;, name: &quot;junit&quot;, version: &quot;4.12&quot;
&#125;

compileKotlin &#123;
    kotlinOptions.jvmTarget = &quot;1.8&quot;
&#125;

compileTestKotlin &#123;
    kotlinOptions.jvmTarget = &quot;1.8&quot;
&#125;</code></pre>
<p>首先是<code>plugins</code>这段，这一段虽然重要但一般用不着特别操心，按照我的理解大概是语言支持的插件。</p>
<p>接下来是版本、JVM版本之类的，看着也很明白。</p>
<p>然后可以申明一些接下来会用到的常量。</p>
<p><code>repository</code>告诉Gradle从哪里找库。常见的源有内置的函数，例如<code>mavenCentral()</code>，<code>jcenter()</code>。如果是其他的Maven源也可以指定URL。比如说我这里用了阿里云的Maven镜像，在国内速度就会快上很多。</p>
<p>接下来是<code>dependencies</code>，这个是重头戏。</p>
<p>最常见的是<code>implementation</code>，这个后面一般跟库的Maven id。如果想直接引用本地文件可以用<code>files(...)</code>，如果是一个平台一个版本的可以用<code>platform(...)</code>。基本上这就覆盖了99%的用途。</p>
<p>此外还有<code>runtimeOnly</code>，这个和<code>implementation</code>的区别就是<code>runtimeOnly</code>的库是不参与编译的，只在运行期有效。这一般都是用JNI的一众native库和一些二级库。</p>
<p>还有<code>testCompile</code>，用这个修饰的库是只在跑单元测试的时候依赖的，因此基本上都是一些测试有关的库。我人懒，平时懒得写单元测试，因此这个我基本上不用。</p>
<p>这些就是我目前摸索出来的Gradle的基本用法，目前的感觉就是把IDEA里面的很多GUI的操作文字化，非常舒适，省了很多麻烦。更复杂的用法例如自定义build task等都可以在官网上找到（文档很丰富也是Gradle比较吸引人的点）。</p>
<p>最后有一点点想吐槽，就是Groovy似乎单引号和双引号都可以表示字符串。双引号的字符串支持插值，这似乎是唯一的予以区别。IDE默认生成的是单引号，LWJGL的打包器生成的是双引号，似乎最通用的是双引号，自己到底是用双引号还是单引号呢？这种东西真的是万恶之源。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://alan20210202.github.io/2020/03/29/FuckZhihu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/avatar.png">
      <meta itemprop="name" content="Chengyuan Ma">
      <meta itemprop="description" content="不务正业高中生一枚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chengyuan Ma's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/03/29/FuckZhihu/" class="post-title-link" itemprop="url">退乎，与自省</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-03-29 21:08:26" itemprop="dateCreated datePublished" datetime="2020-03-29T21:08:26+08:00">2020-03-29</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-03-30 10:45:22" itemprop="dateModified" datetime="2020-03-30T10:45:22+08:00">2020-03-30</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>上一次发文章已经是三个星期以前了。</p>
<p>感到一丝焦虑，但三个星期中确实没有做成值得写一写的事情是一个令人沮丧的事实。</p>
<p>开学了人忙了是一个原因。人一忙，一个矛盾愈发凸显。</p>
<p><strong>理性上对于系统化学习的追求与感性上沉溺于碎片化知识平台的矛盾。</strong></p>
<p>自己要应付AP考试还有一整本的Gregory Mankiw的经济学要看。</p>
<p>自己现在还在看柏拉图的《理想国》，书很好看，觉得很有启发。</p>
<p>地理的等级考也是要准备起来的。</p>
<p>文书也是要做起准备的。</p>
<p>个人的项目也是要做的。</p>
<p>退一步讲，自己还有一个追番TODO List还要十几部番要追，轻小说TODO List还有几部要抽空看。</p>
<p>当时间就剩下这么一点，知乎这么一个搅屎棍的存在就显得令人恼火了。</p>
<p>自己之前一直看不起快手和抖音，觉得这种垃圾玩意纯粹就是让人上瘾的。</p>
<p>可悲的是，自己也成了知乎的奴隶。</p>
<p>确实我在鄙视链上比抖音快手高一级，但是当鄙视链的每一根链环都足够拴着你吃屎的时候，其实区别不大。</p>
<p>知乎不知不觉成为了我常逛的唯一平台。居然占据了30%的耗电，难道这不恐怖吗？</p>
<p>只是为了看时事，结果刷了一个小时，难道这不恐怖吗？</p>
<p>我觉得是时候好好反思反思了。</p>
<p>要是这一个小时有营养就算了。</p>
<p>现在的知乎，90%的回答就是在玩烂梗。时政问题下就是两个极端的口诛笔伐，喊入关的喊入关，吹国外的吹国外，骂公知的骂公知。党同伐异，贴上标签就开骂，评论区里友善度堪比电竞祖安。</p>
<p>国家自信的大旗已经举起，反公知的政治正确俨然形成。这着实是好事，但是被这股情绪裹挟着消磨时间又是另一回事了。</p>
<p>人们说政治是一个门槛看起来低实际上高得很的学科。谁都能对政治发表一番高论，但是要使理论逻辑自洽，预测准确一致就需要非常高的水平。</p>
<p>知乎上大体是前者。山高死而入关兴，大家都在喊入关，要么就国家拟人化走一波，大家还就好这一口。</p>
<p>敢情我是来看波兰球动画的呢？</p>
<p>不然要么就恶政隐或者膜蛤走一波，下面的评论狂喊冲塔冲塔枪毙枪毙药丸药丸下个账号再见，不亦乐乎，谁说天朝子民不可妄议朝政？</p>
<p>但是我现在真的觉得让我们普罗大众表达诉求可以，玩键盘政治或许不值得提倡。</p>
<p>我记得16年刚玩知乎的时候，还是有很多很有意义的回答的。比如说人民群众喜闻乐见的知乎如意勺系列，虽然问题虚构荒诞，但是科普的目的确实达到了。每一篇文章洋洋洒洒干货十足，比起现在一千万和蜗牛的虚构问题不知道高到哪里去了。</p>
<p>现在还有这么多干货文章吗？有的，引经据典的回答终究是有的，之前在知乎上看到的毕导的科普视频也是很好的。但是这些都被大大稀释了，到现在，为了这么一篇好文章刷过50篇朱一旦，营销号，观察者网或者环球时报似乎不值得。</p>
<p>我不知道是资本的入驻使知乎变了味，还是推荐算法使然。</p>
<p>我倾向于后者。</p>
<p>推荐算法实在是太恐怖了。</p>
<p>它恐怖就恐怖在它是一个正反馈系统，平衡点是不稳定的。只要思想稍有偏差，就会迅速滚到一个极端去。</p>
<p>它迎合你，让你每一时刻都享受英雄所见略同的快感。很多时候看前两句句你就知道这篇文章要讲啥，但是禁不住讲的东西你喜欢，于是又看了下去。很多时候回答就只有两句，篇幅完全不重要。我逛知乎的心态已经从以往的获取知识，到寻求附和与认同为主，能看到啥就学啥为辅的情况了，非常可悲。自己当真就没有独立思考的能力和对此的自信？</p>
<p>小群体内的自我认同除了加深偏执以外不会引入新的思想，甚至还会降低你对异见的容忍度，看到不一样的观点就烦躁，哪怕它的长篇大论是真的有论点有论据有深度可以学到东西的。知乎里现在键政领域两极分化，推荐算法功不可没。</p>
<p>当一个问答网站将迎合用户，附和用户作为首要任务，而不是去挑战用户的认知，扩充用户的头脑的话，这个网站可就真的忘了初心，出了大问题了。</p>
<p>或许也没有忘初心，万一人家初心就是赚钱呢。</p>
<p>现在想想我每天干嘛？去知乎看人嘲讽美国防疫，还是看人调侃美股八熔八耻？</p>
<p>但是我又不是靠知乎获得这些信息的。我每天一大早都是自己去JHU的网站上查人数，自己查道指的。小米内置的资讯在遇到大新闻的时候也没落下。也就是我不断心理暗示知乎是一个获得时政新闻的平台，其实根本不是。那我天天去干嘛？我贱不贱啊？贱不贱啊？</p>
<p>自己完全是被动地被知乎牵着鼻子走，可太悲哀了。</p>
<p>另一方面，知乎的产品设计实在是太高明了。</p>
<p>我觉得我还是要回归搜索引擎。</p>
<p>搜索引擎有两个好，一个是它没有针对个人的推荐算法，另一个是你永远有主动权。你搜索什么它给什么。你不搜它不给，爽到。搜出来的结果分散于网络，不容易对于一个平台形成粘性。因此，只要搜索引擎的算法不是特别差（比如说Google），用搜索引擎就不会有大问题。</p>
<p>被搜索引擎带到知乎和直接在知乎搜索栏里搜索是完全两个不一样的概念。</p>
<p>搜索引擎的覆盖面比知乎高，那我为啥不用搜索引擎呢？</p>
<p>我要学习技术，我为啥不去SO、V2EX、SF之类的呢？</p>
<p>同样是刷手机，我为啥不去B站上看看罗翔追追番呢？前者能普法，后者比看垃圾梗更娱乐一点。</p>
<p>为什么呢？</p>
<p>自己之前真的是懒。妄想着知乎一个平台就够了，结果被灌屎，被偶尔尝到的糖吊着胃口，持续地被喂屎。</p>
<p>太糟糕了，实在是太糟糕了。</p>
<p>丹麦哲学家 Søren Kierkegaard 讲过一句话，现在想起来觉得实在是太对了。</p>
<blockquote>
<p>People demand freedom of speech as a compensation for the freedom of thought which they seldom use.</p>
</blockquote>
<p>把知乎卸了。搜索引擎搜到还是会看一下，但是不会主动逛了。</p>
<p>但愿不会真香。</p>
<hr />
<p>其实吧，我觉得，自己退出知乎的这个决定在我看来也是很可悲的。</p>
<p>因为这是我对于无法解决实际问题的一个逃避。</p>
<p>控制不住逛知乎，知乎用户粘性很高是外因，自己不自制是内因。外因通过内因而起作用。</p>
<p>有的时候我觉得虽然学校的政治课大多弱智，但是一些矛盾论以及唯物辩证的思路终究还是受用的。</p>
<p>自己究竟什么时候才会认认真真审视自己自制力不够的问题呢？</p>
<p>我如何才能避免自己看知乎变成看B站呢？</p>
<p>我自以为知乎比B站容易上瘾，先这么自以为着吧。与自己的颓废欲望做出妥协。</p>
<hr />
<p>搜索引擎让我掌握了主动权，但是主动权往往是不够的。我要主动搜啥呢？</p>
<p>正如YPM里面Humphrey说的，I have to know everything so that I can decide whether I need them!</p>
<p>我也有同学说知乎平台里面有很多宝藏回答，我自己也觉得很多时候知乎的热榜里有热点新闻，这是知乎的价值。</p>
<p>可以料想到的是，我现在退出知乎以后，终究要有一个信息平台顶替它的位置，keeping myself well-informed.</p>
<p>这个平台会是什么呢？</p>
<p>我不期望是一个正反馈的系统，今日头条之类的肯定不行。</p>
<p>直接看新闻？新闻是一个无反馈的系统，但为了避免被带入一家的政治立场当中去就要各种立场的新闻都看，不知道有没有时间。</p>
<p>并没有人设计过负反馈的信息平台，估计也不会有人设计这种吃力不讨好的玩意，虽然这是最好的。</p>
<p>朋友圈或许可以，让亲戚朋友代我受这些正反馈平台的戕害自然是最好不过的了（感觉自己的思想还是有点阴暗），反正他们在朋友圈几句话也不足以左右我本身的判断，他们转发的文章我也未必要看，我要的就是这件事情本身，这样我就可以自己去搜了。</p>
<p>唉。有的时候我觉得学数理之类的不用区分立场，逻辑与实验自有定论，省了我的脑细胞，是我作为理科生的幸运，但让我缺乏批判性思考的锻炼，又是我作为理科生的不幸。以至于面对正反馈带来的立场极端化不得不采取“闭关锁国”的战略，我也不知道是不是好事。我一直认为，如果有人能够依靠自己的批判性思维带来的负反馈效用力压推荐算法的正反馈，以至于在主流平台当中依然可以保持相对地客观，那是真的厉害。</p>
<p>另一种自暴自弃的思路莫过于，创造一种统一的政治立场，有一个绝对的权威来树立绝对的政治正确，这样大家都处在同一个立场，提前到达了正反馈的极限，正反馈也就没用了。这正如西方对于我国的态度。一个小圈子里互相认同而偏执是悲哀，但是如果几十亿人不断地相互认同而产生的根深蒂固的思潮，我也不知道是好是坏。它确实湮灭了所有的异见也降低了头脑在这个问题的负担，但也导致新思维的短缺。站在民智发展的角度来看，这样很危险，但是站在统战的角度上，这样似乎又不是不行。</p>
<p>我从未学过认知论也从未学过教育学，但是我推断人类的认知过程本身不可避免地是一个先天的正反馈过程，别人的认可是激励，别人的反驳是惩罚。在基础教育的过程中，“别人”单指老师与同学，因此这个思路被不断提倡，而当到了网络的辩论场，人们自动就会把“别人”的定义延拓了。要逆转这个态势，审慎地对待别人的认可，积极地面对别人的反驳，小心翼翼地避免矫枉过正，在这个时代还要对抗推荐算法，实在是不容易。而如果只有一个人能够做到这一步，那么这个人被孤立于群体之中，也未必如之前一样快乐。</p>
<p>因此我越看《理想国》，越觉得像里面的苏格拉底一样在辩论中不恼羞成怒诉诸于人身攻击，反而通过设问，在多个立场之间来回切换，将辩论用作真正探寻真理的途径而非自我膨胀的乱骂一通，实在是一种非常高明的智慧。我觉得自己离这个境界差远了，而对于是否所有人都能拥有这个智慧，是否应该拥有这份智慧，拥有这份智慧之后是否会感到快乐，我现在很悲观。</p>
<p>唉，自己社科不行，也只能乱发牢骚一通。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://alan20210202.github.io/2020/02/28/Manjaro-VM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/avatar.png">
      <meta itemprop="name" content="Chengyuan Ma">
      <meta itemprop="description" content="不务正业高中生一枚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chengyuan Ma's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/02/28/Manjaro-VM/" class="post-title-link" itemprop="url">用LaTeX实时记数学笔记？！</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-28 08:42:53" itemprop="dateCreated datePublished" datetime="2020-02-28T08:42:53+08:00">2020-02-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-03-02 14:50:03" itemprop="dateModified" datetime="2020-03-02T14:50:03+08:00">2020-03-02</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>我几个月前看到国外有人<a target="_blank" rel="noopener" href="https://castel.dev/post/lecture-notes-1/">分享</a>用LaTeX实时记1700页数学笔记的感受，当时就被惊艳到了，心生向往。这次因为疫情待在家里上在线课程，总算是给了我一个带电脑进课堂的机会。于是我也仿照原作者的做法尝试了用记LaTeX笔记，这篇文章就来写一写我配置环境时遇到的坑和使用感受。</p>
<h1 id="系统选择">系统选择</h1>
<p>原文的作者采用的是Ubuntu发行版+bspwm作为桌面管理器，但是bspwm太小众，网上的资料很少。而且实测装在Ubuntu上默认的配置在视觉上不协调（还要自己去装一个像样的状态栏，总之就是太烦了）。相比之下i3作为另一个Tiling Window Manager比bspwm资料多多了，也比较适合我这种小白。权衡之下我选用Manjaro + i3。在Virtual Box下安装。</p>
<h1 id="配置镜像">配置镜像</h1>
<p>这一步不是必须的，因为Manjaro的默认源在国内的速度也还可以接受（~400kBps）。但是换了交大的源之后可以到10MBps：</p>
<pre class="line-numbers shell"><code class="language-none">sudo pacman -Syy
sudo pacman-mirrors -i -c China -m rank
sudo pacman -Syyu</code></pre>
<p>然后编辑<code>/etc/pacman.conf</code>加上ArchLinuxCN的交大镜像：</p>
<pre class="line-numbers"><code class="language-ini">[archlinuxcn]
SigLevel = Optional TrustedOnly
Server = https://mirrors.sjtug.sjtu.edu.cn/archlinux-cn/$arch</code></pre>
<p>最后导入一下密钥环，镜像就配置完了：</p>
<pre class="line-numbers shell"><code class="language-none">sudo pacman -Syy &amp;&amp; sudo pacman -S archlinuxcn-keyring</code></pre>
<h1 id="安装virtual-box-ga">安装Virtual Box GA</h1>
<p>Manjaro默认对于虚拟机的支持不是很好。我不选择在VMWare上装Manjaro的主要原因也是因为我没有找到VMWare下自动分辨率比较简单的解决方案。在Virtual Box下只要装Virtual Box Guest Addition就可以了，美滋滋。</p>
<p>先安装基本的编译套件：</p>
<pre class="line-numbers shell"><code class="language-none">sudo pacman -S gcc make</code></pre>
<p>然后查看一下Linux内核版本：</p>
<pre class="line-numbers shell"><code class="language-none">uname -r</code></pre>
<p>是5.4，因此安装5.4的headers：</p>
<pre class="line-numbers shell"><code class="language-none">sudo pacman -S linux54-headers</code></pre>
<p>之后在Virtual Box菜单下插入GA的iso文件。我最初是手动挂载的（因为找不到i3里面怎么开文件管理器），就是<code>sudo blkid</code>看一下设备然后<code>mount</code>（如果出现不支持<code>iso9660</code>直接重启）。后来意识到文件管理器的名字是<code>pcmanfm</code>，再发现默认可以直接<code>mod + F3</code>打开文件管理器，于是就可以在上面直接操作了。<code>cd</code>进去运行<code>autorun.sh</code>跑完重启。就发现可以自动适应外部分辨率以及共享剪贴板了，非常方便。</p>
<h1 id="配置键位">配置键位</h1>
<p>默认Manjaro配置的<code>mod</code>键是<code>super</code>，也就是Win键。但是实测Win键在虚拟机环境下会有小问题（例如Win + L总是会被Windows先拦截导致锁屏）。所以我到<code>~/.i3/config</code>里面把<code>mod</code>键改成了<code>alt</code>。我还把i3默认的<code>jkl:</code>键位改成了和Vim相一致的<code>hjkl</code>键位。</p>
<h1 id="中文相关">中文相关</h1>
<p>Manjaro默认的中文渲染很有问题（装系统的时候居然没有中文字体！）。因此需要手动配置中文的渲染。</p>
<p>我基本上是按照<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Font_Configuration/Chinese_(简体中文)">Arch Wiki</a>上的Android类字体配置的。但是Arch Wiki上没有配置给终端用的等宽字体，需要个人发挥一下。我最喜欢的等宽字体是Sarasa Gothic（因为有中文）（去除中文我现在最喜欢的是Jetbrains Mono）。我发现ArchLinuxCN的源上已经有这款字体了，于是直接安装：</p>
<pre class="line-numbers shell"><code class="language-none">sudo pacman -S ttf-sarasa-gothic</code></pre>
<p>然后修改<code>~/.Xresources</code></p>
<pre class="line-numbers"><code class="language-ini">URxvt.font: xft:Sarasa Term SC:size=12</code></pre>
<p>重启一下就好了（其实不用重启，<code>xrdb ~/.Xresources</code>也行？）</p>
<p>接着是输入法。我原来准备装搜狗的，但是搜狗因为各种奇奇怪怪的原因（比如说字体找不到，比如说默认装<code>fcitx</code>的时候没有<code>qt4</code>的支持需要额外安装）不能用，在各种坑之后我决定不用它改用sunpinyin+cloud pinyin的组合，试用下来也是相当令人满意的：</p>
<pre class="line-numbers shell"><code class="language-none">sudo pacman -S fcitx-im
sudo pacman -S fcitx-configtool
sudo pacman -S fcitx-sunpinyin fcitx-cloudpinyin</code></pre>
<p>安装后在<code>~/.xprofile</code>里面加上下列几行启用fcitx</p>
<pre class="line-numbers shell"><code class="language-none">export GTK_IM_MODULE=fcitx
export QT_IM_MODULE=fcitx
export XMODIFIERS=&quot;@im=fcitx&quot;
fcitx -d</code></pre>
<p>最后一行是我自己加上的，因为似乎由于一些原因fcitx它开机不自启……</p>
<h1 id="配置tex">配置TeX</h1>
<p>终于可以开始进入正题了，首先安装TeXLive：</p>
<pre class="line-numbers shell"><code class="language-none">sudo pacman -S texlive-most texlive-langchinese</code></pre>
<p>接着安装Vim Plug，在<code>~/.vimrc</code>里面写入自动安装脚本（手动安装亦可）以及一些基本的配置：</p>
<pre class="line-numbers"><code class="language-vim">set number
set tabstop=4
set softtabstop=4
set shiftwidth=4
set smartindent

syntax on

if empty(glob(&#39;~/.vim/autoload/plug.vim&#39;))
    silent !curl -fLo ~/.vim/autoload/plug.vim --create-dirs
        \ https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
    autocmd VimEnter * PlugInstall --sync | source $MYVIMRC
endif</code></pre>
<p>接着安装所必要的VimTeX插件以及UltiSnips插件并进行相关的配置：</p>
<pre class="line-numbers"><code class="language-vim">call plug#begin(&#39;~/.vim/plugged&#39;)

Plug &#39;lervag/vimtex&#39;
let g:tex_flavor=&#39;latex&#39;
let g:vimtex_view_method=&#39;zathura&#39;
let g:vimtex_quickfix_mode=0
set conceallevel=1
let g:tex_conceal=&#39;abdmg&#39;

Plug &#39;sirver/ultisnips&#39;
let g:UltiSnipsExpandTrigger=&#39;&lt;tab&gt;&#39;
let g:UltiSnipsJumpForwardTrigger=&#39;&lt;tab&gt;&#39;
let g:UltiSnipsJumpBackwardTrigger=&#39;&lt;s-tab&gt;&#39;
let g:UltiSnipsSnippetDirectories=[&#39;mysnippets&#39;]

call plug#end()</code></pre>
<p>安装Zathura作为PDF阅读器：</p>
<pre class="line-numbers shell"><code class="language-none">sudo pacman -S zathura zathura-pdf-mupdf</code></pre>
<p>我查到Manjaro i3终端默认的背景色是<code>#222D31</code>，因此在<code>~/.config/zathura/zathurarc</code>里面写入</p>
<pre class="line-numbers"><code class="language-none">set default-bg &quot;#222D31&quot;
set recolor &quot;true&quot;
set recolor-lightcolor &quot;#222D31&quot;
set recolor-darkcolor &quot;#FFFFFF&quot;</code></pre>
<p>这样Zathura打开白色的pdf文档的时候就会自动重新着色，完成了色调上的统一。</p>
<p>Vimtex默认使用<code>latexmk</code>编译，<code>latexmk</code>默认调用<code>pdflatex</code>。因为要用中文我们希望它调用<code>xelatex</code>，于是在<code>~/.latexmkrc</code>里面加上</p>
<pre class="line-numbers"><code class="language-none">$pdf_mode = 1;
$pdflatex = &#39;xelatex --shell-escape %O %S&#39;;</code></pre>
<p>现在随便打开一个tex文档，打出<code>\ll</code>，预览就冒出来了，非常方便。</p>
<h1 id="配置snippets">配置Snippets</h1>
<p>我基本上复制了作者原博客上的大部分snippets的定义。再加上了一些我觉得比较常用的：</p>
<pre class="line-numbers"><code class="language-none">snippet exm &quot;example&quot; bA
\begin&#123;example&#125;
$1
\end&#123;example&#125;
$0
endsnippet

snippet sln &quot;solution&quot; bA
\begin&#123;solution&#125;
$1
\end&#123;solution&#125;
$0
endsnippet

snippet -&gt; &quot;arrow&quot; A
\Rightarrow
endsnippet

snippet sc &quot;since&quot; wA
\because
endsnippet

snippet tf &quot;therefore&quot; wA
\therefore
endsnippet

snippet tx &quot;text&quot; wA
\text&#123;$1&#125;$0
endsnippet

snippet par &quot;()&quot; wA
\left($1\right)$0
endsnippet

snippet pbk &quot;[]&quot; wA
\left[$1\right]$0
endsnippet

snippet pbr &quot;&#123;&#125;&quot; wA
\left\\&#123;$1\right\\&#125;$0
endsnippet

snippet pabs &quot;||&quot; wA
\left|$1\right|$0
endsnippet

snippet enum &quot;enumerate&quot; bwA
\begin&#123;enumerate&#125;
$1
\end&#123;enumerate&#125;
$0
endsnippet

snippet ml &quot;multiline math&quot; bwA
\begin&#123;gather*&#125;
$1
\end&#123;gather*&#125;
$0
endsnippet</code></pre>
<p>笔记源文件的preamable定义如下，使用<code>fleqn</code>选项对所有方程进行左对齐，并定义<code>example</code>和<code>solution</code>环境方便记例题和解答：</p>
<pre class="line-numbers"><code class="language-latex">\documentclass[fleqn]&#123;ctexart&#125;

\usepackage&#123;amsthm&#125;
\usepackage&#123;amsmath&#125;
\usepackage&#123;amssymb&#125;
\usepackage&#123;tikz&#125;

\newtheorem*&#123;solution&#125;&#123;解&#125;
\newtheorem&#123;example&#125;&#123;例&#125;[subsection]

\begin&#123;document&#125;
    \maketitle
    ...
\end&#123;document&#125;</code></pre>
<p>最后的效果如下：</p>
<p><img src="https://s2.ax1x.com/2020/03/02/3RRrp6.png" alt="3RRrp6.png" /></p>
<p>成果：</p>
<p><img src="https://s2.ax1x.com/2020/03/02/3Rojqf.png" alt="3Rojqf.png" /></p>
<p>对比手写版：</p>
<p><img src="https://s2.ax1x.com/2020/03/02/3Ro6PJ.jpg" alt="3Ro6PJ.jpg" /></p>
<p>是不是看起来还不错？</p>
<h1 id="使用感受">使用感受</h1>
<h2 id="优点">优点</h2>
<ul>
<li>格式内容分离，便于重新排版与整理</li>
<li>字体统一美观（自己手写的字实在是太丑了哇）</li>
<li>例题的自动编号很赞！</li>
</ul>
<h2 id="缺点">缺点</h2>
<ul>
<li><p>Vim原来就有两个常用的模式，输入法的使用又增加了一个模式。来回shift切换打断了编辑的流畅性，降低了效率。尤其是很多时候输入法还没切回英文就<code>jj</code>一下或者切片段，结果还要删掉，按shift，然后重新打，有的时候着实糟心。</p></li>
<li><p>Snippets多固然增加了效率，但是也增加了记忆的负担。对于我这种新手来说，过多的snippets只是把打LaTeX的时间转换成回忆用哪个snippet比较好的时间，一下子增加太多snippets也会降低效率。</p></li>
<li><p>错字的存在。搜狗输入法对于偶尔的打错具有自动修正的功能，但是无论是谷歌拼音还是sunpinyin在这方面都不行，加上很多时候这些输入法的选词并不智能，一个个看过来选词其实也是非常耗费时间的。</p></li>
<li><p>还是错字，例如“已知”错打成“一直”，英文可以配置spell checker做实时的纠正，这在原文当中也有提到，但是中文目前在这方面还缺乏支持。我听说百度有这方面的接口，但是不知道对于数学笔记专业性这么强的语料效果怎么样。Vim插件我是肯定没找到。</p></li>
<li><p>笔记的结构比较松散，在笔记本上我们可以拿箭头划来划去，有旁注也可以轻松插入，但是这在LaTeX当中绝非易事。很多时候数学笔记的格式很容易让人陷入纠结，比如说我乱打的一段</p>
<blockquote>
<p>设<span class="math inline">\(y=kx+b,\quad (k\neq 0)\)</span></p>
<p><span class="math inline">\(\Rightarrow x=\frac{y-b}{k}\)</span>又因为已知<span class="math inline">\(k=\tan \alpha\)</span>...</p>
</blockquote>
<p>这种格式要怎么排版呢？</p>
<ol type="1">
<li>是整个作为一个大的display style math，中文文字作为<code>\text&#123;&#125;</code>镶嵌其中？</li>
<li>还是一行一个display-style math?</li>
<li>还是有中文字的行用inline math，然后纯数学符号的行用display math?</li>
<li>要不要用<code>gather*</code>这种环境？</li>
</ol>
<p>又比如说如下这段：</p>
<blockquote>
<p><span class="math inline">\(\begin{cases}x=1 \\y=2\end{cases}\)</span>或<span class="math inline">\(\begin{cases}x=2 \\y=1\end{cases}\)</span></p>
</blockquote>
<p>手写起来非常简单，但是LaTeX代码呢？</p>
<pre class="line-numbers"><code class="language-latex">$\begin&#123;cases&#125; x=1 \\ y=2 \end&#123;cases&#125;$
或
$\begin&#123;cases&#125; x=2 \\ y=1 \end&#123;cases&#125;$</code></pre>
<p>一下子复杂了不少，更别说为了中间的“或”字需要输入法切换。这是snippets也难以挽救的低效。</p></li>
<li><p>我还没有试过画图。但是这一定是一个天坑。</p></li>
<li><p>如果编译失败那几乎是当场去世（悲）</p></li>
</ul>
<h1 id="总结">总结</h1>
<p>就我个人体验而言，用LaTeX记笔记虽然能够达到非常高的排版质量，但是并没有传说中的那么高效（尤其是在使用中文的背景之下）。用LaTeX整理笔记自然是极好的，但是用LaTeX在课堂上实时记笔记绝对属于一大作死行为（更别说你也不知道老师收不收LaTeX记得笔记对不？）</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://alan20210202.github.io/2020/02/23/PyMinecraft/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/avatar.png">
      <meta itemprop="name" content="Chengyuan Ma">
      <meta itemprop="description" content="不务正业高中生一枚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chengyuan Ma's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/02/23/PyMinecraft/" class="post-title-link" itemprop="url">用Python非侵入式自动化原版Minecraft</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-02-23 19:16:19 / 修改时间：20:34:39" itemprop="dateCreated datePublished" datetime="2020-02-23T19:16:19+08:00">2020-02-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>似乎博客又有一个月没有更了呢<del>而且一个月前挖的坑似乎还没有填完? 持续咕咕咕</del></p>
<p>我前几天玩Minecraft挖矿的时候我就一直在思考一个问题</p>
<blockquote>
<p>如何自动化MC里面像挖矿这么无脑的操作呢？</p>
</blockquote>
<p>其实现成的想法还是很多的：</p>
<ol type="1">
<li>用粘液块和红石（Slimestone）实现半自动化（例如SciCraft里面的盾构）。SciCraft用这个方法挖了103000颗钻石，优点是纯原版，缺点是其实还是很肝，而且技术性非常强。</li>
<li>利用mod的解决方案：像IC2，Mekanism这些mod其实都有自动化的解决方案。优点是比较简单。缺点是非原版，通用性比较差，而且自动挖矿在这些mod里面基本上也是大后期了，搭这一套措施很肝。</li>
<li>利用客户端mod的解决方案：利用FreeCam或者透视这种客户端mod可以在服务端原版的情况下达到类似自动化的效果，但是缺点是这个是作弊。</li>
<li>Carpet Mod：这个mod的<code>/player</code>命令是在服务端生成一个假的玩家实体并进行操作，好处就是简单，快捷，不会掉线。而且Carpet现在搭了Fabric的顺风车更新得非常勤快。缺点就是服务端要装Carpet，如果不是自己开服基本用不了，而且说实话Carpet的自动化比较简单（本来是配合SciCraft那一套设计的）。</li>
<li><a target="_blank" rel="noopener" href="http://minerl.io/">MineRL</a>：直接利用强化学习解决一切自动化问题。优点是几乎啥都可以干，缺点是技术含量非常非常高，而且训练的硬件要求非常高。说实话我觉得是overkill。</li>
</ol>
<p>这些方案各有优缺点，其实对于我这种玩偶尔玩第三方服务器的人2、3、4基本上就可以否决掉了，1的话门槛比较高，5的话没有那硬件资源。所以这几天我自己试验了一个适合我需求的方案，还算不错。</p>
<h1 id="初步设计">初步设计</h1>
<p>简单来说呢，我的想法是这个样子的</p>
<ol type="1">
<li>不断截取游戏窗口</li>
<li>通过OCR读取F3界面的字符</li>
<li>获得玩家的位置</li>
<li>通过闭环控制器控制玩家行动</li>
<li>通过模拟键盘和鼠标事件来进行实际的控制</li>
</ol>
<p>这个解决方案和MineRL靠的比较近，都是比较贴近于实际玩游戏的过程。我最看重的一个有点就是这个解决方案完全不需要修改客户端，而且因为F3界面格式万年不变而且从很早版本就有了导致这个解决方案的版本兼容性超强，即使是玩第三方服务器第三方客户端也丝毫不虚。那么剩下来的就是用Python实现这一连串过程了。</p>
<h1 id="用到的第三方库">用到的第三方库</h1>
<pre class="line-numbers"><code class="language-python">import cv2 as cv
import numpy as np

import win32gui
import win32ui
import win32con

import keyboard
import mouse</code></pre>
<p>上面是图像处理标准操作，中间是Win32标准操作，下面是鼠标和按键模拟用的（其实用win32api也可以解决，但是我还是想保留一点OS兼容性）。</p>
<h1 id="游戏窗口截取">游戏窗口截取</h1>
<p>因为我用的是Windows所以这个部分理所应当地用Pywin32来做，我个人对于Win32 API不是特别地熟悉（常年面向MSDN编程），Pywin32做接口之后就更搞不清楚了，于是上网上东抄抄西抄抄就做完了。我把这部分代码理了一下，通用性还是比较高的。</p>
<pre class="line-numbers"><code class="language-python">Hwnd = int

def get_window_with_title(keyword: str) -&gt; Hwnd:
    &quot;&quot;&quot;
    Gets the first window whose title contains the keyword, if any
    !!! WIN 32 ONLY !!!
    :param keyword: the keyword
    :return: the first window whose title contains keyword, None if not found
    &quot;&quot;&quot;

    def callback(hwnd: Hwnd, extra: List[Hwnd]):
        if win32gui.IsWindowVisible(hwnd) and win32gui.IsWindowEnabled(hwnd) \
                and keyword in win32gui.GetWindowText(hwnd):
            extra.append(hwnd)

    ret: List[Hwnd] = []
    win32gui.EnumWindows(callback, ret)
    return ret[0] if ret else None


def capture_screen_of(hwnd: Hwnd, rect=None) -&gt; np.ndarray:
    &quot;&quot;&quot;
    Capture screen of hwnd, using win32 API
    !!! WIN 32 ONLY !!!
    :param hwnd: the window handle
    :param rect: the rectangle, default value None, which means to capture the whole window
    :return: the screen capture (RGBA) in numpy array format
    &quot;&quot;&quot;
    window_dc = win32gui.GetWindowDC(hwnd)
    dc_object = win32ui.CreateDCFromHandle(window_dc)
    compat_dc = dc_object.CreateCompatibleDC()
    bitmap = win32ui.CreateBitmap()
    if not rect:
        rect = win32gui.GetWindowRect(hwnd)
        rect = (0, 0, rect[2] - rect[0], rect[3] - rect[1])
    width, height = rect[2] - rect[0], rect[3] - rect[1]
    start = (rect[0], rect[1])
    bitmap.CreateCompatibleBitmap(dc_object, width, height)
    compat_dc.SelectObject(bitmap)
    compat_dc.BitBlt((0, 0), (width, height), dc_object, start, win32con.SRCCOPY)
    img = np.frombuffer(bitmap.GetBitmapBits(True), dtype=&#39;uint8&#39;)
    img.shape = (height, width, 4)
    dc_object.DeleteDC()
    compat_dc.DeleteDC()
    win32gui.ReleaseDC(hwnd, window_dc)
    win32gui.DeleteObject(bitmap.GetHandle())
    return img</code></pre>
<p>（出于常年写静态语言的习惯还是加上了type annotation）</p>
<h1 id="ocr">OCR</h1>
<p>这是最头大的部分了，我一开始的想法非常天真：Tesseract OCR，G家这么好的轮子不用干啥。结果</p>
<ol type="1">
<li>Tesseract下载下来好几十MB，这瞬间让整个项目的dependencies复杂了起来。</li>
<li>Tesseract似乎很慢，跑一次F3界面要跑0.5秒，我这算法要是按照2FPS的速度跑那玩家的反射弧要长出天际了。其实考虑到Tesseract很多都是在用LSTM这种速度也不奇怪。</li>
<li>Tesseract对于Minecraft默认像素风字体的支持不好。如果要提升效果就要额外train。</li>
</ol>
<p>这三个因素加起来最终还是把Tesseract枪毙了。Python常见的OCR解决方案似乎只有这一家，所以只能自己设计OCR算法了。</p>
<p>其实在我的这个场景里OCR的要求不高，因为</p>
<ol type="1">
<li>因为是截屏所以像素亮度很平整，也不会有扭曲或者畸变</li>
<li>我可以获取到Minecraft的字体文件</li>
</ol>
<p>这两个因素在一起让这里的OCR退化成了template matching。</p>
<p>从客户端<code>jar</code>文件里提取出来字体文件本身不是一件特别复杂的事，唯一可能复杂一点的地方就是要把字体位图当中透明色变成灰色：</p>
<pre class="line-numbers"><code class="language-python">font_atlas_file = &quot;unicode_page_00.png&quot; # Minecraft的Unicode字体位图
font_atlas = cv.imread(font_atlas_file, cv.IMREAD_UNCHANGED)
font_atlas = cv.threshold(font_atlas[:, :, 3], 127, 255, cv.THRESH_BINARY)[1]</code></pre>
<p>接下来是文字提取。经过我的测试Minecraft的F3界面文字在灰度图像下的前景色在<code>220-225</code>左右非常固定，而且文字背后半透明灰色的遮罩使文字的周围不会出现干扰。这样提取文字部分只需要threshold一下就解决了，运用OpenCV的代码非常简短：</p>
<pre class="line-numbers"><code class="language-python">f3_color = (221, 225)
...
# cap是截图
img = cv.cvtColor(cap, cv.COLOR_BGR2GRAY if cap.shape[2] == 3 else cv.COLOR_BGRA2GRAY)
img = cv.threshold(img, f3_color[1], 255, cv.THRESH_TOZERO_INV)[1]
img = cv.threshold(img, f3_color[0] - 1, 255, cv.THRESH_BINARY)[1]</code></pre>
<p>接下来只要对于字符集当中的每一个文字，从字体位图里面找到点阵字体然后跑模板匹配就行了</p>
<pre class="line-numbers"><code class="language-python">chars: List[Tuple[int, int, str]] = []
for ch in charset:
    font = bitmap_fonts[ord(ch)]
    x = cv.matchTemplate(img, font, cv.TM_CCORR_NORMED)
    # noinspection PyTypeChecker
    chars.extend(zip(*np.where(x &gt; match_threshold), repeat(ch)))</code></pre>
<p>最后是把识别出来的单个字符串联成行。这一部分的主要思路是把纵坐标在一定范围内的字符按照横坐标排序然后顺次拼接就行了。下面的代码还可以做亿点优化，但是这一部分不是本算法的瓶颈（上面的模式匹配才是），所以我懒了：</p>
<pre class="line-numbers"><code class="language-python">img_width = img.shape[1]
chars.sort(key=lambda tup: tup[0] * img_width + tup[1])
last_y = -1 - max_line_height_deviation
lines: List[List[Tuple[int, int, str]]] = []
for ch in chars:  
    if ch[0] - last_y &gt; max_line_height_deviation:
        last_y = ch[0]
        lines.append([])
    lines[-1].append(ch)
ret: List[str] = []
for line in lines: 
    line_str: str = &quot;&quot;
    error = True
    for (i, ch) in enumerate(line):
        if i &gt; 0 and ch[1] - line[i - 1][1] &gt; whitespace_width:  
            line_str += &#39; &#39;
        line_str += ch[2]
        error &amp;= ch[2] in [&#39;.&#39;, &#39;-&#39;, &#39;_&#39;]  
    if not error:
            ret.append(line_str)
return ret</code></pre>
<p>注意要集中处理的是有些字符会因为字体的原因容易被错误识别，例如<code>.</code>, <code>_</code>, <code>-</code>(后两个在MC的字体里面根本就是一样的)。这一部分要去除。同时因为空格无论怎么样都不会被模板匹配识别出来，所以要通过字间距的差别来插入。</p>
<p>这个算法的运行时间是和字符集大小成正比的，因此字符集的精简很重要。在这里我其实只采用了<code>0123456789XYZFLa./-</code>这些字符，这些数字和符号确保可以正常识别数字，<code>XYZ</code>确保可以识别坐标，<code>Fa</code>确保可以识别朝向（<code>Facing</code>），<code>L</code>确保可以识别指向（<code>Looking at</code>）。总体来说这一部分的算法虽然简陋但是堪堪够用。在精简字符集后可以跑到20FPS，已经是Tesseract的10倍多了。</p>
<p>在试验过程中比较有意思的一个发现是Minecraft的默认ASCII字体渲染是一个比较复杂的过程，似乎不是按照<code>ascii.png</code>上的内容直接来的（我的理解是似乎加了一些hint），导致模板匹配的思路在ASCII字体的时候是行不通的，必须在设置里面强制开启Unicode字体。</p>
<h1 id="读取玩家信息">读取玩家信息</h1>
<p>在OCR之后读取玩家信息就是水到渠成的事情了。我的OCR已经把行都划好了，只需要选取特定字符开头的行做一下字符串分割和parse就完成了。</p>
<h1 id="闭环控制">闭环控制</h1>
<p>最后一步当然是通过一个闭环控制器来控制玩家的运动。这一部分出于我在机器人社的经验我糊了一个P controller <del>ID部分懒得写了</del>来控制玩家的朝向，再写了个bang bang control来控制玩家的XZ坐标（在生存模式下Y坐标一般来说是控制不了的）。稍微比较烦的地方就是MC对于方位角的表示方式，需要一些分类讨论和转换。控制频率100Hz，效果差强人意，已经足够作为一个proof-of-concept了：</p>
<pre class="line-numbers"><code class="language-python">def control_thread_func(coord_tol: float = 0.5, yaw_tol: float = 2, pitch_tol: float = 2):
    &quot;&quot;&quot;
    The control thread. If abs(error_target) &lt;= x_target, then the target will be considered reached
    :param coord_tol: coordinate tolerance
    :param yaw_tol: yaw tolerance
    :param pitch_tol: pitch tolerance
    :return: runs forever
    &quot;&quot;&quot;
    kp_yaw, kp_pitch = 0.5, 0.4 
    global target_yaw
    global target_pitch
    global reached_yaw
    global reached_pitch
    global reached_coord
    w, a, s, d = False, False, False, False # 记录WASD四个键状态
    move_threshold = 0.5 # 如果在一个坐标分量上的偏差小于这个值那就不按这个分量上的按键了
    turn_threshold = 1.5 # 每一次鼠标至少要动这么多

    def key_cond(val, key, cond):
        if val and not cond:
            keyboard.release(key)
            return False
        if not val and cond:
            keyboard.press(key)
            return True
        return val

    while True:
        if not in_control or not player_info:
            time.sleep(0.05)
            continue

        yaw, pitch = player_info.facing
        coord = xyz2xz(player_info.coord)

        # 坐标控制
        error_coord = math.hypot(target_coord[0] - coord[0], target_coord[1] - coord[1])
        reached_coord = error_coord &lt; coord_tol
        theta = math.atan2(target_coord[0] - coord[0], target_coord[1] - coord[1])
        ws = math.cos(theta + math.radians(yaw)) * error_coord
        ad = math.sin(theta + math.radians(yaw)) * error_coord
        w = key_cond(w, &quot;w&quot;, ws &gt; move_threshold)
        s = key_cond(s, &quot;s&quot;, ws &lt; -move_threshold)
        a = key_cond(a, &quot;a&quot;, ad &gt; move_threshold)
        d = key_cond(d, &quot;d&quot;, ad &lt; -move_threshold)

        # 摄像头朝向控制
        target_pitch = max(-90, min(90, target_pitch))
        if auto_yaw and not reached_coord: 
            target_yaw = -math.degrees(math.atan2(target_x - x, target_z - z))
        if target_yaw &gt; 180:
            target_yaw -= 180
        if target_yaw &lt; -180:
            target_yaw += 180
        error_yaw = target_yaw - yaw
        if abs(error_yaw - 360) &lt; abs(error_yaw):
            error_yaw -= 360
        if abs(error_yaw + 360) &lt; abs(error_yaw):
            error_yaw += 360
        error_pitch = target_pitch - pitch
        reached_yaw = abs(error_yaw) &lt; yaw_tol
        reached_pitch = abs(error_pitch) &lt; pitch_tol
        if not reached_yaw:
            d_yaw = kp_yaw * error_yaw
            if abs(d_yaw) &lt; turn_threshold:
                d_yaw = math.copysign(turn_threshold, error_yaw)
        else:
            d_yaw = 0
        if not reached_pitch:
            d_pitch = kp_pitch * error_pitch
            if abs(d_pitch) &lt; turn_threshold:
                d_pitch = math.copysign(turn_threshold, error_pitch)
        else:
            d_pitch = 0
        mouse.move(d_yaw, d_pitch, absolute=False)

        time.sleep(0.01)</code></pre>
<h1 id="测试">测试</h1>
<p>写完之后我写了一个简单的挖矿脚本，可以挖1x2的矿道并且插上火把点亮：</p>
<pre class="line-numbers"><code class="language-python">def wait_turn():
    time.sleep(0.01)
    while player_info and (not reached_yaw or not reached_pitch):
        time.sleep(0.05)


def wait_coord():
    time.sleep(0.01)
    while player_info and not reached_coord:
        time.sleep(0.05)

def start_mining():
    global in_control
    global target_coord
    global target_yaw
    global target_pitch
    if player_info is None:
        return
    if player_info.target_block is None:
        return
    direction = xyz2xz(player_info.target_block - np.floor(player_info.coord))
    target_coord = xyz2xz(player_info.coord)
    target_yaw = -math.degrees(math.atan2(direction[0], direction[1]))
    in_control = True
    target_pitch = 0
    moved = 0
    wait_turn()
    try:
        while True:
            moved += 1
            mouse.press() # 开始挖摄像头正对的方向
            while np.linalg.norm(xyz2xz(player_info.target_block - np.floor(player_info.coord))) &lt; 1.:
                time.sleep(0.01)
            mouse.release() # 挖完了
            if moved % 5 == 0: # 每挖五格就插一个火把（在副手）
                target_yaw += 30
                wait_turn()
                mouse.right_click()
                time.sleep(0.1)
                target_yaw -= 30
            target_pitch = 40 # 低头
            wait_turn()
            mouse.press() # 开始挖下面的那一格
            while np.linalg.norm(xyz2xz(player_info.target_block - np.floor(player_info.coord))) &lt; 1.:
                time.sleep(0.01)
            mouse.release()
            target_coord = xyz2xz(np.floor(player_info.coord)) + np.array([0.5, 0.5]) + 0.7 * direction # 前进！
            target_pitch = 0 # 双眼平视前方
            wait_turn()
            wait_coord()
    except Exception:
        in_control = False
        mouse.release()
        print(&quot;exit&quot;)
        return
</code></pre>
<p>这个脚本运行的非常顺畅（虽然并不总是成功，这和玩家坐标控制的精度有很大关系）。已经初步有了实用价值。看起来我这个技术路线总体还是可行的。当然现在的功能非常简陋，但是F3的信息非常丰富，如果拓展一下用途还是非常丰富的。当然最重要的还是这个脚本可以适用于所有有F3界面的Minecraft版本，版本兼容性堪称完美，爽到。</p>
<p><del>写这个脚本花了2个小时，就是为了挖一个简单的矿，这么算来似乎有点亏？！</del></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://alan20210202.github.io/2020/01/28/%E7%BB%84%E5%90%88%E6%81%92%E7%AD%89%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/avatar.png">
      <meta itemprop="name" content="Chengyuan Ma">
      <meta itemprop="description" content="不务正业高中生一枚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chengyuan Ma's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/01/28/%E7%BB%84%E5%90%88%E6%81%92%E7%AD%89%E5%BC%8F/" class="post-title-link" itemprop="url">论一个有趣组合恒等式的证明</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-01-28 20:33:26 / 修改时间：20:33:03" itemprop="dateCreated datePublished" datetime="2020-01-28T20:33:26+08:00">2020-01-28</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="问题">问题</h1>
<p>前几天在做探究性题目的时候碰到了一个组合恒等式： <span class="math display">\[
\sum_{k=1}^nk2^k\binom{2n-k-1}{n-1}=n\binom{2n}{n}
\]</span> 这个恒等式的右边最初是Mathematica给出的，当时把就我惊到了，一开始想用combinatorial proof的方法来证，但是想了两个晚上也想不出，自己的数学实在是太烂啦=_= 之后在翻《具体数学》的时候学了一点超几何函数的皮毛，总算使用超几何的方法诡异地证出来了。我又在Math StackExchange上发帖征集了一些初等的证明，在这里做一个汇总。</p>
<h1 id="初等证明">初等证明</h1>
<p><strong>引理1：</strong> <span class="math display">\[
\sum_{k=n}^{2n}2^{-k}\binom{k}{n}=1
\]</span> <strong>证明：</strong>源于<a target="_blank" rel="noopener" href="https://math.stackexchange.com/questions/1782432/how-to-prove-that-sum-i-0n-2i-binom2n-in-4n">这个帖子</a>。这个式子等价于： <span class="math display">\[
\sum_{k=n}^{2n}2^{2n-k}\binom{k}{n}=4^n \Rightarrow \sum_{k=0}^{n}2^{k}\binom{2n-k}{n}=4^n
\]</span> 利用数学归纳法，令 <span class="math display">\[
\begin{aligned}
    S_n&amp;=\sum_{k=0}^{n}2^{k}\binom{2n-k}{n}\\
    &amp;=\sum_{k=0}^{n}2^{k}\binom{2n-k}{n-k} \\
    &amp;=\sum_{k=0}^{n}2^{n-k}\binom{n+k}{n}
\end{aligned}
\]</span> 于是 <span class="math display">\[
\begin{aligned}
    S_{n+1} &amp;= \sum_{k=0}^{n+1}2^{n+1-k}\binom{n+1+k}{n+1} \\
    &amp;= \sum_{k=0}^{n+1}2^{n+1-k}\left[\binom{n+k}{n+1} + \binom{n+k}{n}\right] \\
    &amp;= \binom{2n+1}{n} + 2\sum_{k=0}^{n}2^{n-k}\binom{n+k}{n} + \sum_{k=0}^{n+1}2^{n+1-k}\binom{n+k}{n+1}\\
    &amp;= \binom{2n+1}{n} + 2S_n + \binom{2n+1}{n+1} + \sum_{k=1}^{n}2^{n+1-k}\binom{n+k}{n+1} \\
    &amp;= \binom{2n+2}{n+1} + 2\cdot4^n + \sum_{k=0}^{n-1}2^{n-k}\binom{n+1+k}{n+1} \\
    &amp;= \binom{2n+2}{n+1} + 2\cdot4^n + \frac{1}{2}\left[\sum_{k=0}^{n+1}2^{n+1-k}\binom{n+1+k}{n+1}-2\binom{2n+1}{n+1}-\binom{2n+2}{n+1}\right] \\
    &amp;= 2\cdot4^n + \frac{1}{2}S_{n+1} \\
    \Rightarrow S_{n+1}&amp;=4^{n+1}
\end{aligned}
\]</span></p>
<p>结合数学归纳法，得证。</p>
<p><strong>引理2：</strong> <span class="math display">\[
\sum_{p=m}^{2m}p2^{-p}\binom{p}{m} = (2m+1)-\frac{m+1}{2^{2m+1}}\binom{2m+2}{m+1}
\]</span> <strong>证明：</strong>源于<a target="_blank" rel="noopener" href="https://math.stackexchange.com/questions/3508530/help-in-summing-sum-k-m-2m-k-cdot-2-k-k-choose-m/3508683#3508683">这个帖子</a>。 <span class="math display">\[
\begin{aligned}
\sum_{p=m}^{2m}p2^{-p}\binom{p}{m} &amp;= \sum_{p=m}^{2m}(p+1)2^{-p}\binom{p}{m} -\sum_{p=m}^{2m}2^{-p}\binom{p}{m} \\
&amp;= \sum_{p=m}^{2m}(m+1)2^{-p}\binom{p+1}{m+1} - 1\\
&amp;= (m+1) \left[2\sum_{p+1=m+1}^{2m+2}2^{-(p+1)}\binom{p+1}{m+1}-2^{-2m-1}\binom{2m+2}{m+1}\right] - 1 \\
&amp;= (m+1)\left[2-\frac{1}{2^{2m+1}}\binom{2m+2}{m+1}\right] - 1\\
&amp;= (2m+1)-\frac{m+1}{2^{2m+1}}\binom{2m+2}{m+1}
\end{aligned}
\]</span> 得证。</p>
<p><strong>原式证明：</strong>结合引理1和2，令<span class="math inline">\(m=n-1,p=2n-k-1\)</span>： <span class="math display">\[
\begin{aligned}
    \sum_{k=1}^nk2^k\binom{2n-k-1}{n-1}&amp;=\sum_{p=m}^{2m}(2m+1-p)2^{2m+1-p}\binom{p}{m} \\
    &amp;=2^{2m+1}\sum_{p=m}^{2m}(2m+1-p)2^{-p}\binom{p}{m} \\
    &amp;= 2^{2m+1}\left[(2m+1)-(2m+1)+\frac{m+1}{2^{2m+1}}\binom{2m+2}{m+1}\right] \\
    &amp;= (m+1)\binom{2m+2}{m+1}\\
    &amp;= n\binom{2n}{n}
\end{aligned}
\]</span> 整个证明神乎其技，学不来学不来，感觉自己实在是太菜了。</p>
<h1 id="生成函数证明">生成函数证明</h1>
<p>帖子里有，看起来非常短，我对于生成函数还不熟练，积极学习中~TODO: 看懂了整理上来。</p>
<h1 id="组合证明">组合证明</h1>
<p>帖子里有，看起来非常不短，似乎用了很多non-trivial的论证方法，试图理解中~TODO: 看懂了整理上来。</p>
<h1 id="超几何证明">超几何证明</h1>
<p>这个证明是我在翻《基础数学》看到超几何函数那一节的时候想的，是这四个证明中唯一一个我原创的证明（悲）。用到了超几何函数，蒟蒻高中生感觉非常炫酷.jpg</p>
<p>首先把等式左边改成无限求和： <span class="math display">\[
\begin{aligned}
\sum_{k=1}^{n}k2^k\binom{2n-d-1}{n-1} &amp;= \sum_{k=1}^{n}k2^k\binom{2n-k-1}{n-k} \\
&amp;= \sum_{k=1}^{\infty}k2^k\binom{2n-k-1}{n-k} \\
&amp;= \sum_{k=0}^{\infty}(k+1)2^{k+1}\binom{2n-k-2}{n-k-1}
\end{aligned}
\]</span> 若令<span class="math inline">\(t_k=(k+1)2^{k+1}\binom{2n-k-2}{n-k-1}\)</span>，则观察到： <span class="math display">\[
\begin{aligned}
\frac{t_{k+1}}{t_k} &amp;= \frac{(k+2)2^{k+2}\binom{2n-k-3}{n-k-2}}{(k+1)2^{k+1}\binom{2n-k-2}{n-k-1}} \\
&amp;= \frac{2(k+2)[k+(1-n)]}{(k+1)[k+(2-2n)]} \\
\end{aligned}
\]</span> 是一个关于<span class="math inline">\(k\)</span>的有理式，因此引入高斯超几何函数： <span class="math display">\[
\begin{aligned}
\mathrm{LHS} &amp;=t_0\cdot {}_2F_1(2,1-n;2-2n;2)\\
&amp;=2\binom{2n-2}{n-1} {}_2F_1(2,1-n;2-2n;2)
\end{aligned}
\]</span> 考虑化简超几何项，利用如下Kummer二次变换（他1836年论文的Eq.54）： <span class="math display">\[
{}_2F_1(a,b;2b;z)=\frac{1}{(1-z)^{a/2}}{}_2F_1\left(\frac{1}{2}a,b-\frac{1}{2}a;b+\frac{1}{2};\frac{z^2}{4z-4}\right)
\]</span> 则得到： <span class="math display">\[
{}_2F_1(2,1-n;2-2n;2)=-{}_2F_1(1,-n;\frac{3}{2}-n;1)
\]</span> 因为都是实参数且<span class="math inline">\(1-n&lt;\frac{3}{2}-n\)</span>，因此运用高斯定理： <span class="math display">\[
\begin{aligned}
{}_2F_1(1,-n;\frac{3}{2}-n;1) &amp;= \frac{\Gamma\left(\frac{3}{2}-n\right)\Gamma\left(\frac{1}{2}\right)}{\Gamma\left(\frac{1}{2}-n\right)\Gamma\left(\frac{3}{2}\right)} \\
&amp;= 2\left(\frac{1}{2}-n\right) \\
&amp;= 1-2n
\end{aligned}
\]</span> 一路代回去： <span class="math display">\[
\begin{aligned}
\mathrm{LHS} &amp;= 2\binom{2n-2}{n-1} {}_2F_1(2,1-n;2-2n;2) \\
&amp;= 2(2n-1)\binom{2n-2}{n-1} \\
&amp;= 2n\binom{2n-1}{n-1} \\
&amp;= n\binom{2n}{n} = \mathrm{RHS}
\end{aligned}
\]</span> 证毕。</p>
<p>整个证明过程颇有一种高射炮打蚊子的既视感。超几何函数各种公式一大堆还千奇百怪，套就完事了，然而无论是Kummer的二次变换还是高斯定理我都不知道怎么证（悲）。 我已经把Ahlfors的Complex Analysis存起来了，决定有空看看（不知道会不会有这方面的内容）。</p>
<p>嘛，在初等证明存在的情况下，用这种严重超纲的做法只能给人一种装逼的错觉<del>虽然我感觉有点开心？</del>，别人看你搞不好都跟关爱智障一样。MSE上果然大佬太多，向大佬低头.jpg。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://alan20210202.github.io/2020/01/22/JuliaPlots/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/avatar.png">
      <meta itemprop="name" content="Chengyuan Ma">
      <meta itemprop="description" content="不务正业高中生一枚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chengyuan Ma's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/01/22/JuliaPlots/" class="post-title-link" itemprop="url">让Plots.jl支持中文标题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-01-22 17:36:08 / 修改时间：20:25:19" itemprop="dateCreated datePublished" datetime="2020-01-22T17:36:08+08:00">2020-01-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Julia Plots啥都好，就是原生对于Unicode的支持还不完善（可见用Julia的国人似乎不多）。这篇文章简要汇总一下几个不同的backend对于中文的workaround。</p>
<h1 id="gr-backend">GR Backend</h1>
<p>GR在支持Unicode字符上进展感觉其实不积极。具体可以看<a target="_blank" rel="noopener" href="https://github.com/jheinen/GR.jl/issues/143">这个issue</a>，修了一年还是没有比较好的成果（作者说是一个extensive patch...估计一开始在架构里写死了），只修到了支持Latin-1的地步，目前提供的临时解决方案是：</p>
<pre class="line-numbers"><code class="language-julia">ENV[&quot;GKS_ENCODING&quot;]=&quot;utf-8&quot;
using Plots</code></pre>
<p>在Windows上实测对于png格式的图片还是不行，但是对于SVG是可以的（但是因为计算布局的时候字符串长度算的是有问题的，所以legend的框会偏小）。</p>
<h1 id="pyplot-backend">PyPlot Backend</h1>
<p>PyPlot背后调用的是matplotlib，因此PyPlot默认对于中文的支持不利主要也来自于matplotlib对中文的支持问题。对于后者网上改<code>rcParams</code>的解决方案已经比较普及了。在Julia里面，我们只需要把<code>rcParams</code>暴露出来改就行了：</p>
<pre class="line-numbers"><code class="language-julia">using Plots
pyplot()
rcParams = Plots.PyCall.PyDict(Plots.PyPlot.matplotlib.&quot;rcParams&quot;)
rcParams[&quot;font.sans-serif&quot;] = [&quot;Sarasa UI SC&quot;]
rcParams[&quot;axes.unicode_minus&quot;] = false</code></pre>
<p>其中的<code>"Sarasa UI SC"</code>可以替换成电脑上安装的中文字体。这样中文标题就一点问题也没有了，但是似乎在Juno里面PyPlot画出来的图不会自动缩放，令强迫症稍微感到一丝不适。</p>
<h1 id="plotlyjs-backend">PlotlyJS Backend</h1>
<p>原生支持。</p>
<h1 id="inspectdr-backend">InspectDR Backend</h1>
<p>原生支持。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://alan20210202.github.io/2020/01/14/WebAssembly/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/avatar.png">
      <meta itemprop="name" content="Chengyuan Ma">
      <meta itemprop="description" content="不务正业高中生一枚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chengyuan Ma's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/01/14/WebAssembly/" class="post-title-link" itemprop="url">WebAssembly初体验</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-01-14 13:16:58 / 修改时间：21:40:13" itemprop="dateCreated datePublished" datetime="2020-01-14T13:16:58+08:00">2020-01-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>我在之前用JavaScript实现了PageDewarp的核心算法。但是众所周知，JavaScript作为一门解释性语言并不适合运算密集型的任务，导致算法运行一次要30秒钟……这个效率虽然不能算特别差，我还是不满意的。所以又花了两天学习了WebAssembly把瓶颈算法用C重写了，现在在手机端一次也只需要1秒左右，效果自然是极好的。但是WebAssembly毕竟还是新科技，和现有的一些框架融合的确实不算好，在应用的过程中踩了非常多的坑，尤其是对于我这种1个月前还是Web萌新的人更是新坑老坑一起踩到怀疑人生（悲）。</p>
<h1 id="webassembly-emscripten">WebAssembly &amp; Emscripten</h1>
<p>什么是WebAssembly？</p>
<p>WebAssembly是一种通过将静态的系统编程语言（比如说C，C++，Rust）AOT编译成一种基于栈虚拟机架构的字节码，然后在浏览器端再次实时JIT执行，来逼近这些语言native performance的技术。</p>
<p>(<em>吐槽：</em>我最初看到WebAssembly的时候有一种莫名的，很强烈的Java Applet的既视感。)</p>
<p>和CLR类似，WebAssembly只是字节码的标准，至于将特定语言编译成字节码的实现则是那些语言自己的事情。在目前的生态下，C和C++有名为Emscripten的基于LLVM的编译器，Rust则有它们自己的一套toolchain，两者都处于勉强凑活的水平。</p>
<p>就我个人而言我其实觉得Rust在这方面做得最好，官方维护，官方文档。wasm_bindgen也给自定义数据结构类型提供了很好的支持，非常适合大项目开发。但是我只是实现一个小算法，Rust的那一套太重了，有一种boilerplate会比真正代码多的预感，所以我最终选择了C（至于为什么不是C++，那是因为name mangling已经破坏了我对它FFI能力产生了非常深的心理阴影）。</p>
<p>前面说了，C对接WebAssembly的工具链是Emscripten。现在Emscripten的生态已经相对比较成熟了，跟着官方的<a target="_blank" rel="noopener" href="https://emscripten.org/docs/getting_started/downloads.html">Getting Started</a>走基本上就没有问题。写C的时候就按照正常的写法（我感觉Emscripten对于libc里面的大多数常用函数都做了适配）写就可以了。算法的代码很短：</p>
<pre class="line-numbers"><code class="language-c">#include &lt;math.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;emscripten.h&gt;

typedef struct v3 &#123;
    float x, y, z;
&#125; v3;
v3 add(v3 a, v3 b) &#123;
    return (v3) &#123; .x = a.x + b.x, .y = a.y + b.y, .z = a.z + b.z &#125;;
&#125;
v3 mul(v3 a, float k) &#123;
    return (v3) &#123; .x = a.x * k, .y = a.y * k, .z = a.z * k &#125;;
&#125;
v3 a2v(float *a) &#123;
    return (v3) &#123; .x = a[0], .y = a[1], .z = a[2] &#125;;
&#125;
EMSCRIPTEN_KEEPALIVE
unsigned char *dewarp(
        unsigned char *src, int srcWidth, int srcHeight,
        int dstWidth, int dstHeight,
        float *cpX, float *cpY,
        float *upperLeft, float *baseVec, float *normalVec, 
        float *vertical, float d
        ) &#123;
    v3 ul = a2v(upperLeft);
    v3 bv = a2v(baseVec);
    v3 nv = a2v(normalVec);
    v3 vt = a2v(vertical);
    unsigned char *dst = malloc(4 * dstWidth * dstHeight);
    for (int x = 0; x &lt; dstWidth; x++) &#123;
        v3 top = add(ul, add(mul(bv, cpX[x]), mul(nv, cpY[x])));
        for (int y = 0; y &lt; dstHeight; y++) &#123;
            v3 c = add(top, mul(vt, (float)y / dstHeight));
            float sx = c.x / (1 + c.z / d); 
            float sy = c.y / (1 + c.z / d); 
            sx = (sx + 0.5f) * srcWidth;
            sy = sy * srcWidth + 0.5f * srcHeight;
            int di = (y * dstWidth + x) * 4;
            int si = ((int)round(sy) * srcWidth + (int)round(sx)) * 4;
            dst[di] = src[si];
            dst[di + 1] = src[si + 1];
            dst[di + 2] = src[si + 2];
            dst[di + 3] = src[si + 3];
        &#125;
    &#125;
    return dst;
&#125;</code></pre>
<p>注意函数前面加的<code>EMSCRIPTEN_KEEPALIVE</code>宏，这个宏一方面导出了函数，另一方面防止LLVM过于智能把这段函数当成dead code消除掉或者内联掉。如果不用这个宏，就需要在编译选项里加上<code>-s EXPORTED_FUNCTIONS="['_dewarp']"</code>。注意<strong>Emscripten在导出函数名称的时候都在前面加上了<code>_</code></strong>，直接引用的时候不能漏掉。</p>
<p>另外一个要注意的点是程序内部是无法直接访问JavaScript里面的变量的，我用的是Vue，那就更不用说了。所有要用到的context都需要在参数里面传进来。而目前来说，Emscripten对于自定义结构体之类的支持很少，传参基本上只支持primitive types和指针。除此以外，在指针方面吧，Emscripten并没有自动帮我们做好数组的转换，这一部分需要自行编写，一维的还容易一点，高维的写起来就更难受了。可以参考这个<a target="_blank" rel="noopener" href="https://github.com/Planeshifter/emscripten-examples">repo</a>。</p>
<pre class="line-numbers"><code class="language-javascript">function copyToHeap(typedArray) &#123;
  let size = typedArray.length * typedArray.BYTES_PER_ELEMENT;
  let offset = Module._malloc(size);
  Module.HEAPU8.set(new Uint8Array(typedArray.buffer), offset);
  return offset;
&#125;

Module[&quot;dewarp&quot;] = function(src, srcWidth, srcHeight, dstWidth, dstHeight, cpX, cpY, upperLeft, baseVec, normalVec, vertical, d) &#123;
  let pSrc = copyToHeap(src);
  let pCpX = copyToHeap(cpX), pCpY = copyToHeap(cpY);
  let pUL = copyToHeap(upperLeft), pBV = copyToHeap(baseVec);
  let pNV = copyToHeap(normalVec), pVertical = copyToHeap(vertical);
  let pDst = Module._dewarp(pSrc, srcWidth, srcHeight, dstWidth, dstHeight, pCpX, pCpY, pUL, pBV, pNV, pVertical, d);
  let ret = new Uint8ClampedArray(4 * dstWidth * dstHeight);
  ret.set(new Uint8ClampedArray(Module.HEAPU8.buffer, pDst, 4 * dstWidth * dstHeight));
  Module._free(pSrc); Module._free(pDst);
  Module._free(pCpX); Module._free(pCpY);
  Module._free(pUL); Module._free(pBV);
  Module._free(pNV); Module._free(pVertical);
  return ret;
&#125;;</code></pre>
<p>WebAssembly内部是简单的线性内存空间，可以使用<code>Module.HEAPU8</code>来获取一个<code>U8</code>的View。调用的时候直接<code>Module._dewarp</code>，依然注意要在C函数名前面加<code>_</code>。官方还提供了了<code>ccall</code>的调用方式，会自动对字符串做转码，在这里并不需要。在调用时指针一律当做整数处理。在返回时直接把返回数组在内存中的数据复制一份就行了。之后记得全部<code>free</code>掉就行了。</p>
<p>编译的指令是：</p>
<pre class="line-numbers shell"><code class="language-none">emcc -O3 dewarp.c -o dewarp.js --post-js dewarp_post.js \
    -s ENVIRONMENT=&quot;web&quot; \
    -s MODULARIZE=1 \
    -s ALLOW_MEMORY_GROWTH=1</code></pre>
<p>选项的意义如下：</p>
<ul>
<li><code>-O3</code>：优化级别，和一般的C编译器类似。<code>-O3</code>是最激进的优化之一。除了在字节码上优化还会minify生成的接口js。</li>
<li><code>-o dewarp.js</code>：生成的接口文件名。</li>
<li><code>--post-js dewarp_post.js</code>：把<code>dewarp_post.js</code>（也就是上面<code>copyToHeap</code>所在的文件）附到生成的<code>dewarp.js</code>后。类似地还有<code>--pre-js</code>。</li>
<li><code>-s ENVIRONMENT="web"</code>：默认Emscripten在编译接口文件的时候会同时加入node和浏览器环境下不同的加载方案。我们这边只需要浏览器环境，加上这个选项有助于减少生成的接口js大小。何况在使用webpack的情况下不开这个webpack会傻乎乎地把<code>fs</code>加到dependencies里面然后报错，这个时候要不这里加选项要不webpack那里额外配置二选一。</li>
<li><code>-s MODULARIZE=1</code>：在写Emscripten的js端的文件的时候<code>Module</code>是一个关键的变量。在默认情况下Emscripten把它定义为全局变量。这会造成命名污染。如果加上这个选项，编译出来的代码就相当于是在一个大的<code>function</code>里面。这个函数接受一个预先加了点东西的<code>Module</code>对象，加上自己的私货（还有我们在<code>dewarp_post.js</code>里面定义的helper函数）之后返回完成的<code>Module</code>。确保不会产生命名污染的问题。同时Emscripten会自动把这个大函数设成<code>module.exports</code>。</li>
<li><code>-s ALLOW_MEMORY_GROWTH=1</code>：默认的内存空间是固定的，这个选项允许内存空间的扩张。图像处理算法占的内存比较大，不加这个选项会爆内存。</li>
</ul>
<p>另外还有两个常用的选项：</p>
<ul>
<li><code>-s EXPORTED_FUNCTIONS="['_foo', ...]"</code>：指定要导出的函数，这里的名称要加下划线。等号右边是js列表的写法。如果在C源码要导出的函数前加上<code>EMSCRIPTEN_KEEPALIVE</code>的话这里就不需要再指明了。</li>
<li><code>-s EXTRA_EXPORTED_RUNTIME_METHODS="['ccall', ...]"</code>：默认Emscripten不会把很多API导出，因为这有助于减小接口文件的大小，但是如果要用<code>ccall</code>和<code>cwrap</code>之类的API的话就要在这里指明。</li>
</ul>
<p>（自己一开始<code>-s</code>开头的选项一个都不知道要加，然后疯狂出问题，就暴毙了）</p>
<p>编译完之后会生成两个文件，一个是接口的js文件，一个是wasm文件，里面存放的就是字节码了。</p>
<h1 id="javascript端的磨合">Javascript端的磨合</h1>
<p>Emscripten上的教程在这里说得非常轻巧：只要<code>&lt;script/&gt;</code>引入，然后接口js会自动加载wasm文件，然后调用方法就行了。这样做是没错，但是忽略了一点：大家现在都在用webpack之类的打包器，这类打包器面对WebAssembly需要特殊的配置才能确保其顺利运行。</p>
<p>我之前一直避免自己动webpack配置这种东西，因为我觉得Vue CLI帮我安顿得挺好的自己一搞搞不好怎么挂的都不知道。刚开始配置我这个萌新就真马上跌进坑里了：网上教程里面写的都是<code>webpack.config.js</code>，然后我一直试都没有效果，纳闷了很久，才发觉因为我用的是Vue CLI，所以配置都在<code>vue.config.js</code>里面：</p>
<pre class="line-numbers"><code class="language-javascript">module.exports = &#123;
  ...
  configureWebpack: &#123;
    // 原来webpack.config.js的内容
  &#125;
&#125;;</code></pre>
<p><del>这种坑有经验的开发者都不会进去吧？还是我太菜了</del></p>
<p>同时注意如果开启ESLint的话，注意一定要在<code>.eslintignore</code>文件里面加上接口js，一方面自动生成的js不需要lint，另一方面由于上下文不足lint下来会有很多误报。</p>
<p>在webpack的配置上，对于两种文件分别采取如下策略：</p>
<ul>
<li>wasm文件就是普通文件，应该使用<code>file-loader</code>。</li>
<li>js文件由于采用<code>-s MODULARIZE=1</code>编译开关，会把一个函数挂载到<code>module.exports</code>上，这个时候就要用<code>exports-loader</code>加载。</li>
</ul>
<p>我这个萌新一开始对于loader的概念很困惑。因为我一开始觉得webpack一个打包的东西有哪里需要load呢？在那里用这些loader呢？后来意识到loader机制的意思是把</p>
<pre class="line-numbers"><code class="language-javascript">import foo from &quot;bar&quot;</code></pre>
<p>转变成</p>
<pre class="line-numbers"><code class="language-javascript">var foo = some_loader(&quot;bar&quot;);</code></pre>
<p>这件事情其实是挺有意思的。静态语言写多了就觉得模块导入语句应该有固定的语义才对，结果到JavaScript这里发现<code>import</code>其实纯粹是类似语法糖的元素，语义不固定=_=。</p>
<p>倒腾一圈下来我项目当中的webpack配置如下：</p>
<pre class="line-numbers"><code class="language-javascript">&#123;
  module: &#123;
    rules: [
      &#123;
        test: /dewarp\.js$/,
        loader: &quot;exports-loader&quot;
      &#125;,
      &#123;
        test: /dewarp\.wasm$/,
        type: &quot;javascript/auto&quot;,
        loader: &quot;file-loader&quot;,
      &#125;
    ]
  &#125;,
&#125;</code></pre>
<p>还没完，在javascript代码里面这样写：</p>
<pre class="line-numbers"><code class="language-javascript">// 指定用exports-loader，所以wasmInterface现在就是Emscripten导出的那个返回Module的大函数
import wasmInterface from &quot;./wasm/dewarp.js&quot;
// 指定用file-loader，所以wasmBytecode现在就是指向wasm文件的路径
import wasmBytecode from &quot;./wasm/dewarp.wasm&quot;

let wasmModule = wasmInterface(&#123;
  // Emscripten导出的函数可以接受一个已经塞了东西的对象作为Module的基础
  // 可以在里面定义Emscripten文档里面写的一些特殊函数，比如说这里的locateFile
  // 如果定义了，在加载字节码的时候就会调用这个函数获取path的真实有效值，因为webpack
  // 调整了文件位置关系，而Emscripten生成接口脚本时写入的是生成时的文件位置，因此我们
  // 就必须在这个函数里告诉它真实的文件位置，不然会404翻车
  locateFile(path) &#123;
    return path.endsWith(&quot;.wasm&quot;) ? wasmBytecode : path;
  &#125;
&#125;); // 创建对象之后自动加载
wasmModule.onRuntimeInitialized = () =&gt; &#123;
  // 文件加载完毕
&#125;;</code></pre>
<p>在这么一番操作之后，我才终于可以在原来的地方写上</p>
<pre class="line-numbers"><code class="language-javascript">wasmModule.dewarp(...) // 调用dewarp_post.js里面的helper函数，间接调用C函数</code></pre>
<p>整个过程挺折腾的，但事实也确实证明这么折腾一番是值得的，性能提升三十倍，非常愉悦。</p>
<h1 id="结论">结论</h1>
<p>总体下来我觉得WebAssembly现在技术上已经趋于成熟了，像我第一次积累了经验之后以后再用WebAssembly不踩那些坑的话体验是相当不错的。当然对于Emscripten来说在调用时的转化上目前还不是那么智能，还有很多要改进的地方（这也可能和JavaScript太放飞自我的设计有关？），使用Rust的开发我还没有试过，看官方文档上Game of Life的demo觉得非常有意思（我觉得Rust真的是绝对的后起之秀，各种方面的）。</p>
<p>更有意思的是，这还不是优化的终点。我听说WebAssembly还有一个SIMD的提案，这似乎又可以让性能提升若干个台阶（当然我不知道目前的JIT VM能不能根据字节码进行自动向量化）。还真的就是啥native上的技术都往web端搬，浏览器也是啥活现在都要揽=_=，估计过几年就真成一个小的操作系统了（ChromeOS: Hold my chrome :）</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>


<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengyuan Ma</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/prism.min.js" integrity="sha512-YBk7HhgDZvBxmtOfUdvX0z8IH2d10Hp3aEygaMNhtF8fSOvBZ16D/1bXZTJV6ndk/L/DlXxYStP8jrF77v2MIg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/plugins/line-numbers/prism-line-numbers.min.js" integrity="sha512-br8H6OngKoLht57WKRU5jz3Vr0vF+Tw4G6yhNN2F3dSDheq4JiaasROPJB1wy7PxPk7kV/+5AIbmoZLxxx7Zow==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-bash.min.js" integrity="sha512-JvRd44DHaJAv/o3wxi/dxhz2TO/jwwX8V5/LTr3gj6QMQ6qNNGXk/psoingLDuc5yZmccOq7XhpVaelIZE4tsQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-c.min.js" integrity="sha512-T6Lco61aWqCKSznWkd38lf159pD0+EwZ9UCEv6ARAvaWFiy/UHtYgOmlasT8lq5Ck17ZNHzbe5eHUablTGRXxw==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-cmake.min.js" integrity="sha512-M99z3be36IUB5pA3DWoJvjSYaZA9BiUqf1jXzVcjntASBZFNI53oDRzdJqGzH5voybcAx5Sg8F5QyryE6afD3g==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-cpp.min.js" integrity="sha512-hxZJ6OUEpUl9/o4C1gMGvrAbeqDaldBiZbs08c/V8NcU7YImBFlqJAc7Uzjf3bh2W8Wx26/dVDyPk9cUMQY0Mw==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-go.min.js" integrity="sha512-SgF1uayJ2/8TV+MhLasqygnm++vYRXswmrR2ZAmUCL4pXtf+6KzUgXPpn10Y6xca658sxOQEOsoP3MChfhke5A==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-java.min.js" integrity="sha512-PWHY6Vao4E9K4LsGBYCY0ttDeiWZwuUozTbJvSy9UFHRz2J4Bl7rcWML3wEnJTVuCJhSwGne/8My5gTo/gnbpg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-json.min.js" integrity="sha512-IC7rV8RslChgByOdUFC6ePqOGn+OwJhnKC3S5AezM8DAiOdGhJMwgsIvBChsa2yuxxoPbH2+W/kjNUM1cc+jUQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-kotlin.min.js" integrity="sha512-aTozTdtORp/xxS/dhRRDfmv/p1eyEMTje96MplkSOqdbKGGvOYIlogoGdtsh/BD91vaqKoAw9M7O/DodqqudIQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-julia.min.js" integrity="sha512-eTGeKQdDzC2rPAUVfM2Fa36s9B9wp138NEhzZqJpRSdJQ66BwLUot25r2YQveCRU5uYNVfX3gckDkl4byfBIWw==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-latex.min.js" integrity="sha512-6D3l3Fy8g/hr6AeK2g1rcVZHyFjCqiqgUrwy0mBZTGFd8UwVcUDhzQeIIv3eYeXDecGPTtBOS9ctyRzJyUgypQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-rust.min.js" integrity="sha512-kgT7r2HlCEO4b+Rp3nJvm+/EMBwGMvv1WMdWkb3eNgnS91llMli8Y3T1CgnD8Hifqx50Q3XLUQXDd7PzKQQtUA==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-python.min.js" integrity="sha512-wK9tQmDrstGtZqTKcyVf3h457QGMlNriKs+fHmEkiCizrq0LVovfT3v1smeT1DlQetHhdRkkX1JSuZg5LoNHJg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-nginx.min.js" integrity="sha512-/MNzg8GlnVrAau/TZClh1jxgHNX0HDgidbGnHS5x1OtbKiNoK3e0XNd1oV16xmmeDHjisa3GKLArUau+43GZ4A==" crossorigin="anonymous"></script>
<script type = "text/javascript">
    document.addEventListener('pjax:complete', function() {
        if (typeof Prism !== 'undefined') {
            Prism.highlightAll();
        }
    });
</script>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.4.0/pjax.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '.page-configurations',
    '.main-inner',
    '.post-toc-wrap',
    '.languages',
    '.pjax'
  ],
  analytics: false,
  cacheBust: false,
  scrollRestoration: false,
  scrollTo: !CONFIG.bookmark.enable
});

document.addEventListener('pjax:success', () => {
  pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  const hasTOC = document.querySelector('.post-toc');
  document.querySelector('.sidebar-inner').classList.toggle('sidebar-nav-active', hasTOC);
  document.querySelector(hasTOC ? '.sidebar-nav-toc' : '.sidebar-nav-overview').click();
  NexT.utils.updateSidebarPosition();
});
</script>


  






  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



    <div class="pjax">

  <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'none'
      },
      options: {
        renderActions: {
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>



    </div>
</body>
</html>
